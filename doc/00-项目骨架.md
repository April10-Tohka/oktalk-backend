# OKTalk AI 发音纠正系统 - 工程化项目结构设计

> 基于《OKTalk AI 发音纠正功能 PRD v2.0》
> 技术栈：Go + Gin + MySQL + Redis
> 项目规模：毕业设计级（企业级结构）

---

## 一、核心目录结构（完整树形）

```
pronunciation-correction-system/
│
├── cmd/                              # 应用入口点
│   ├── server/
│   │   └── main.go                   # 主程序启动
│   └── migration/
│       └── main.go                   # 数据库迁移工具
│
├── internal/                         # 私有包（不对外暴露 API）
│   ├── config/                       # 配置管理
│   │   ├── config.go                 # 配置结构体定义
│   │   ├── loader.go                 # 配置加载器
│   │   └── env/
│   │       ├── dev.yaml              # 开发环境配置
│   │       ├── test.yaml             # 测试环境配置
│   │       └── prod.yaml             # 生产环境配置
│   │
│   ├── handler/                      # HTTP 处理层（接收请求、解析参数、返回响应）
│   │   ├── health.go                 # 健康检查端点
│   │   ├── evaluation.go             # 发音评测相关接口
│   │   ├── feedback.go               # 反馈相关接口
│   │   ├── user.go                   # 用户相关接口
│   │   └── middleware/
│   │       ├── auth.go               # 认证中间件
│   │       ├── cors.go               # CORS 中间件
│   │       ├── logger.go             # 日志中间件
│   │       └── errorhandler.go       # 错误处理中间件
│   │
│   ├── router/                     # 路由层
│   │   ├── router.go                  # 路由主入口、注册所有模块路由
│   │   ├── auth.go                    # 认证路由 (POST /api/v1/auth/*)
│   │   ├── user.go                    # 用户路由 (GET/PUT /api/v1/user/*)
│   │   ├── chat.go                    # 对话路由 (POST/GET /api/v1/chat/*)
│   │   ├── evaluate.go                # 评测路由 (POST/GET /api/v1/evaluate/*)
│   │   ├── report.go                  # 报告路由 (POST/GET /api/v1/report/*)
│   │   └── resource.go                # 资源路由 (GET /api/v1/resources/*)
│   │
│   ├── service/                      # 业务逻辑层 （核心逻辑）
│   │   ├── evaluation/
│   │   │   ├── service.go            # 评测业务逻辑核心
│   │   │   ├── scorer.go             # 评分与分级逻辑
│   │   │   ├── analyzer.go           # 音素级分析逻辑
│   │   │   └── interfaces.go         # 服务接口定义
│   │   │
│   │   ├── feedback/
│   │   │   ├── generator.go          # 反馈文本生成
│   │   │   ├── levels.go             # 反馈分级规则
│   │   │   └── validator.go          # 反馈质量校验
│   │   │
│   │   ├── audio/
│   │   │   ├── processor.go          # 音频处理（转换、验证）
│   │   │   ├── uploader.go           # 音频上传到 CDN
│   │   │   └── cache.go              # 音频缓存管理
│   │   │
│   │   ├── user/
│   │   │   ├── service.go            # 用户业务逻辑
│   │   │   └── recorder.go           # 用户评测记录管理
│   │   │
│   │   └── interfaces.go             # 所有服务接口合集
│   │
│   ├── db/                            # 数据库操作层
│   │   ├── user.go                    # 用户数据库操作
│   │   ├── chat.go                    # 对话数据库操作
│   │   ├── evaluate.go                # 评测数据库操作
│   │   ├── report.go                  # 报告数据库操作
│   │   ├── text.go                    # 文本数据库操作
│   │   ├── session.go                 # 会话数据库操作
│   │   └── init.go                    # 数据库连接初始化
│   │
│   ├── model/                      # 统一数据模型（GORM + 业务）
│   │   ├── user.go                    # 用户模型（含表映射）
│   │   ├── chat.go                    # 对话相关模型
│   │   ├── evaluate.go                # 评测相关模型
│   │   ├── report.go                  # 报告相关模型
│   │   ├── text.go                    # 文本库模型
│   │   ├── session.go                 # 会话模型
│   │   └── common.go                  # 通用模型结构（如分页）
│   │
│   ├── external/                     # 第三方 API 封装
│   │   ├── xf/                       # 科大讯飞
│   │   │   ├── client.go             # API 客户端
│   │   │   ├── speech_assess.go      # 语音评测接口封装
│   │   │   ├── models.go             # 讯飞数据模型
│   │   │   ├── errors.go             # 讯飞错误处理
│   │   │   └── mocks/
│   │   │       └── mock_client.go    # 测试 Mock
│   │   │
│   │   ├── aliyun/                   # 阿里云
│   │   │   ├── tts/
│   │   │   │   ├── client.go         # CosyVoice TTS 客户端
│   │   │   │   ├── models.go         # 阿里云数据模型
│   │   │   │   └── mocks/
│   │   │   │       └── mock_client.go
│   │   │   │
│   │   │   └── oss/
│   │   │       ├── client.go         # OSS 上传客户端
│   │   │       ├── uploader.go       # 上传逻辑
│   │   │       └── mocks/
│   │   │           └── mock_client.go
│   │   │
│   │   ├── qwen/                     # 通义千问
│   │   │   ├── client.go             # Qwen API 客户端
│   │   │   ├── prompt.go             # Prompt 模板管理
│   │   │   ├── models.go             # 千问数据模型
│   │   │   └── mocks/
│   │   │       └── mock_client.go
│   │   │
│   │   └── interfaces.go             # 所有外部服务接口
│   │
│   ├── cache/                        # 缓存层
│   │   ├── redis/
│   │   │   ├── client.go             # Redis 客户端初始化
│   │   │   ├── keys.go               # Redis Key 定义
│   │   │   └── commands.go           # Redis 操作封装
│   │   │
│   │   ├── evaluation_cache.go       # 评测相关缓存
│   │   ├── feedback_cache.go         # 反馈相关缓存
│   │   ├── audio_cache.go            # 音频 URL 缓存
│   │   └── user_cache.go             # 用户数据缓存
│   │
│   ├── queue/                        # 异步任务队列
│   │   ├── producer.go               # 任务生产者
│   │   ├── consumer.go               # 任务消费者
│   │   ├── tasks/
│   │   │   ├── feedback_generation.go  # 生成反馈任务
│   │   │   ├── audio_generation.go     # 生成示范音频任务
│   │   │   ├── audio_upload.go         # 上传音频任务
│   │   │   └── notification.go         # 通知任务
│   │   │
│   │   └── processor.go              # 任务处理器
│   │
│   ├── pkg/                          # 通用工具包
│   │   ├── logger/
│   │   │   ├── logger.go             # 日志封装
│   │   │   └── fields.go             # 日志字段定义
│   │   │
│   │   ├── db/
│   │   │   ├── mysql.go              # MySQL 连接池
│   │   │   └── transaction.go        # 事务管理
│   │   │
│   │   ├── errors/
│   │   │   ├── errors.go             # 自定义错误类型
│   │   │   ├── codes.go              # 错误码定义
│   │   │   └── handler.go            # 错误处理工具
│   │   │
│   │   ├── validator/
│   │   │   └── validator.go          # 请求参数验证
│   │   │
│   │   ├── audio/
│   │   │   ├── converter.go          # 音频格式转换
│   │   │   ├── validator.go          # 音频文件验证
│   │   │   └── processor.go          # 音频处理工具
│   │   │
│   │   ├── http/
│   │   │   ├── response.go           # 统一响应格式
│   │   │   ├── request.go            # 请求辅助工具
│   │   │   └── client.go             # HTTP 客户端
│   │   │
│   │   ├── retry/
│   │   │   └── retry.go              # 重试机制
│   │   │
│   │   ├── convert/
│   │   │   └── convert.go            # 类型转换工具
│   │   │
│   │   └── uuid/
│   │       └── uuid.go               # ID 生成工具
│   │
│   ├── database/                     # 数据库相关
│   │   ├── migrations/
│   │   │   ├── 001_init_users.sql
│   │   │   ├── 002_init_evaluations.sql
│   │   │   ├── 003_init_feedbacks.sql
│   │   │   └── 004_create_indexes.sql
│   │   │
│   │   └── schema.sql                # 完整数据库 schema
│   │
│   └── constants/                    # 全局常量
│       ├── evaluation.go             # 评测相关常量
│       ├── feedback.go               # 反馈相关常量
│       └── error_codes.go            # 错误码常量
│
│
│
├── go.mod                            # Go 模块定义
├── go.sum                            # 依赖锁定
├── Makefile                          # 编译命令
├── .env.example                      # 环境变量示例
├── .gitignore                        # Git 忽略规则
└── README.md                         # 项目说明
```

---

## 二、关键目录详细说明

### 2.1 Handler 层（HTTP 处理）

```
internal/handler/
├── evaluation.go                     # 核心接口实现
│   ├── SubmitAudioForEvaluation()    # POST /api/v1/voice/evaluate
│   ├── GetEvaluationHistory()        # GET /api/v1/evaluations
│   ├── GetEvaluationDetail()         # GET /api/v1/evaluations/{id}
│   └── RetryEvaluation()             # POST /api/v1/evaluations/{id}/retry
│
├── feedback.go
│   ├── GetFeedbackAudio()            # GET /api/v1/feedback/{id}/audio
│   └── GetDemoAudio()                # GET /api/v1/demo/{word}
│
├── user.go
│   ├── GetUserProfile()              # GET /api/v1/user/profile
│   └── GetUserStats()                # GET /api/v1/user/stats
│
└── middleware/
    ├── auth.go                       # JWT 认证
    ├── cors.go                       # CORS 处理
    ├── logger.go                     # 请求日志
    └── errorhandler.go               # 错误转换为 HTTP 响应
```

**职责**：
- ✅ 接收 HTTP 请求，解析参数
- ✅ 调用 Service 层业务逻辑
- ✅ 返回标准 HTTP 响应（JSON）
- ✅ 参数验证前置

**不做的事**：
- ❌ 不处理业务逻辑
- ❌ 不直接访问数据库
- ❌ 不直接调用外部 API（应通过 Service 代理）

---

### 2.2 Service 层（业务逻辑）

#### 2.2.1 evaluation/ 子包

```
internal/service/evaluation/
│
├── service.go                        # 核心服务（编排）
│   └── Evaluate(ctx, req)           # 发音评测主流程：
│       1. 验证音频文件
│       2. 调用讯飞 API 获取评分
│       3. 调用 Scorer 进行分级
│       4. 触发反馈生成任务（异步）
│       5. 保存评测记录
│       6. 返回基础结果
│
├── scorer.go                         # 评分分级逻辑
│   ├── ScoreAndClassify()            # 90+ → S级，70-89 → A级等
│   ├── IdentifyProblems()            # 识别问题单词（<70分）
│   ├── SelectFeedbackLevel()         # 选择反馈级别
│   └── DetermineDemoType()           # 决定示范音频类型
│
├── analyzer.go                       # 音素级分析
│   ├── AnalyzePhonemes()             # 分析音素细节
│   ├── ExtractProblemPhonemes()      # 提取问题音素
│   └── GenerateDetailReport()        # 生成详细报告
│
└── interfaces.go                     # 服务接口定义
    ├── IEvaluationService
    ├── IScorer
    └── IAnalyzer
```

**职责**：
- ✅ 编排业务流程（评测主逻辑）
- ✅ 调用 Repository 保存数据
- ✅ 调用外部 API（通过 external 包）
- ✅ 调用 Queue 触发异步任务
- ✅ 缓存热数据

**设计模式**：
- 策略模式：不同反馈等级使用不同策略
- 模板方法：EvaluationService 定义流程骨架

---

#### 2.2.2 feedback/ 子包

```
internal/service/feedback/
│
├── generator.go                      # 反馈文本生成
│   ├── GenerateFeedbackText()        # 调用 Qwen API 生成反馈
│   ├── buildPrompt()                 # 根据级别构建提示词
│   └── postProcess()                 # 后处理（检查禁用词）
│
├── levels.go                         # 反馈分级规则
│   ├── SLevelPrompt()                # S 级反馈提示模板
│   ├── ALevelPrompt()                # A 级反馈提示模板
│   ├── BLevelPrompt()                # B 级反馈提示模板
│   ├── CLevelPrompt()                # C 级反馈提示模板
│   └── ForbiddenWords                # 禁用词列表
│
└── validator.go                      # 反馈质量校验
    ├── ValidateFeedback()            # 检查反馈质量
    ├── CheckForNegativeWords()       # 检查负面词汇
    └── CheckWordCount()              # 检查词数限制
```

**关键设计**：
- 反馈分级严格按照 PRD 4.2 的规则
- Prompt 管理集中在 levels.go
- 生成后的反馈需要二次校验

---

#### 2.2.3 audio/ 子包

```
internal/service/audio/
│
├── processor.go                      # 音频处理
│   ├── ValidateAudio()               # 验证音频格式、大小、时长
│   ├── ConvertToWAV()                # 转换为 WAV 格式
│   └── ExtractMetadata()             # 提取音频元数据
│
├── uploader.go                       # 上传到 CDN
│   ├── UploadToOSS()                 # 上传到阿里云 OSS
│   ├── GenerateCDNURL()              # 生成 CDN 访问地址
│   └── SetAccessControl()            # 设置访问权限
│
└── cache.go                          # 缓存管理
    ├── CacheAudioURL()               # 缓存音频 URL
    ├── GetCachedURL()                # 获取缓存 URL
    └── InvalidateCache()             # 失效缓存
```

---

### 2.3 Repository 层（数据访问）

```
internal/repository/
│
├── evaluation/
│   ├── evaluation.go                 # 评测记录 CRUD
│   │   ├── Create()                  # 插入新评测记录
│   │   ├── GetByID()                 # 按 ID 查询
│   │   ├── Update()                  # 更新评测记录
│   │   └── Delete()                  # 删除记录
│   │
│   └── queries.go                    # 复杂查询
│       ├── GetUserEvaluationHistory()  # 分页查询用户评测历史
│       ├── GetEvaluationStatsByUser()  # 统计用户评测数据
│       └── FindProblematicWords()      # 查询用户反复错的单词
│
├── user/
│   └── user.go
│       ├── Create()
│       ├── GetByID()
│       ├── Update()
│       └── UpdateStats()              # 更新用户统计数据
│
├── feedback/
│   └── feedback.go
│       ├── Create()
│       ├── GetByID()
│       └── GetByEvaluationID()
│
└── base.go                           # 基础接口
    ├── IRepository interface
    └── Transaction 支持
```

**关键特性**：
- ✅ 支持事务（创建评测记录 + 反馈记录原子性）
- ✅ 支持批量操作
- ✅ 支持软删除（记录 deleted_at）

---

### 2.4 Model 层（数据模型）

#### 2.4.1 domain/ 子包（业务实体）

```
internal/model/domain/
│
├── evaluation.go                     # 评测实体
│   ├── Evaluation struct
│   │   ├── ID
│   │   ├── UserID
│   │   ├── TargetText              # 目标文本
│   │   ├── RecognizedText          # 识别文本
│   │   ├── Scores *ScoreData       # 关联分数对象
│   │   ├── FeedbackLevel           # S/A/B/C
│   │   ├── Status                  # pending/completed/failed
│   │   ├── CreatedAt, UpdatedAt
│   │   └── ErrorMessage
│   │
│   └── Evaluation.GetProblemWords()  # 获取问题单词列表
│
├── score.go                          # 评分值对象
│   ├── ScoreData struct
│   │   ├── Overall int             # 综合评分
│   │   ├── Accuracy int            # 准确度
│   │   ├── Fluency int             # 流利度
│   │   ├── Integrity int           # 完整度
│   │   ├── Words []WordScore       # 单词级评分
│   │   └── ProblemWords []string   # 问题单词列表
│   │
│   └── WordScore struct
│       ├── Text string
│       ├── Score int
│       ├── Phonemes []PhonemeScore
│       └── IsProblem bool
│
├── feedback.go                       # 反馈实体
│   ├── Feedback struct
│   │   ├── ID
│   │   ├── EvaluationID
│   │   ├── FeedbackLevel           # S/A/B/C
│   │   ├── Text string             # 反馈文本
│   │   ├── AudioURL string         # 反馈音频 CDN 链接
│   │   ├── DemoAudio *DemoAudio
│   │   ├── Status                  # generating/completed/failed
│   │   └── CreatedAt
│   │
│   └── DemoAudio struct
│       ├── Type string             # "word" / "sentence"
│       ├── Content string          # "apples" / "I like apples"
│       └── AudioURL string
│
├── audio.go                          # 音频元数据
│   ├── Audio struct
│   │   ├── ID
│   │   ├── EvaluationID
│   │   ├── OriginalFilename
│   │   ├── Format                  # wav/mp3
│   │   ├── Size int64
│   │   ├── Duration float64        # 秒
│   │   ├── OSS_Key string          # 存储在 OSS 的 key
│   │   └── CreatedAt
│   │
│   └── ValidateAudio() error       # 校验方法
│
├── user.go                           # 用户实体
│   ├── User struct
│   │   ├── ID
│   │   ├── Name
│   │   ├── Email
│   │   ├── Avatar
│   │   ├── TotalEvaluations int
│   │   ├── AverageScore float32
│   │   ├── LastEvaluationAt time.Time
│   │   └── CreatedAt, UpdatedAt
│   │
│   └── UserStats struct            # 用户统计
│       ├── UserID
│       ├── TotalCount int
│       ├── SLevelCount int         # S 级评测数
│       ├── ALevelCount int
│       ├── BLevelCount int
│       ├── CLevelCount int
│       ├── AverageScore float32
│       └── LastUpdatedAt
│
└── constants.go                      # 枚举常量
    ├── FeedbackLevel (S/A/B/C)
    ├── EvaluationStatus (pending/completed/failed)
    ├── AudioFormat (wav/mp3)
    └── DemoType (word/sentence)
```

**设计要点**：
- 值对象（ScoreData、WordScore）用 struct 表示
- 业务实体有方法（如 `Evaluation.GetProblemWords()`）
- 与 DB schema 一一对应

---

#### 2.4.2 dto/ 子包（传输对象）

```
internal/model/dto/
│
├── evaluation_req.go                 # 请求 DTO
│   ├── EvaluateRequest struct
│   │   ├── AudioBase64 string       # Base64 编码的音频
│   │   ├── Text string              # 目标文本
│   │   ├── Level string             # word/sentence/paragraph
│   │   └── Validate() error
│   │
│   └── RetryEvaluationRequest struct
│       └── EvaluationID string
│
├── evaluation_resp.go                # 响应 DTO
│   ├── EvaluateResponse struct
│   │   ├── Code int
│   │   ├── Message string
│   │   └── Data EvaluationData
│   │
│   ├── EvaluationData struct        # 响应体数据
│   │   ├── EvaluationID string
│   │   ├── Scores ScoresDTO
│   │   ├── Feedback FeedbackDTO
│   │   ├── DemoAudio *DemoAudioDTO
│   │   ├── PronunciationDetails []WordDetailDTO
│   │   └── Timestamp string
│   │
│   ├── ScoresDTO struct            # 扁平化的评分数据
│   │   ├── Overall int
│   │   ├── Accuracy int
│   │   ├── Fluency int
│   │   ├── Integrity int
│   │   └── FeedbackLevel string
│   │
│   ├── FeedbackDTO struct
│   │   ├── Text string
│   │   ├── AudioURL string
│   │   └── Duration float64
│   │
│   └── WordDetailDTO struct
│       ├── Word string
│       ├── Score int
│       ├── IsProblem bool
│       └── Phonemes []PhonemeDTO
│
└── convert.go                        # 转换方法
    ├── DomainToDTO()               # domain.Evaluation → EvaluationData
    ├── DTOToDomain()               # EvaluateRequest → domain.Evaluation
    └── ScoresToDTO()               # domain.ScoreData → ScoresDTO
```

**设计原则**：
- Request DTO：只包含来自 HTTP 请求的字段
- Response DTO：按 PRD 响应格式设计（4.2 章）
- 转换器集中在 convert.go

---

#### 2.4.3 po/ 子包（持久化对象）

```
internal/model/po/
│
├── evaluation_po.go                  # 数据库表对应
│   ├── EvaluationPO struct
│   │   ├── ID string                # PK
│   │   ├── UserID string            # FK
│   │   ├── TargetText string
│   │   ├── RecognizedText string
│   │   ├── OverallScore int
│   │   ├── AccuracyScore int
│   │   ├── FluentScore int
│   │   ├── IntegrityScore int
│   │   ├── FeedbackLevel string     # ENUM
│   │   ├── ScoreDetails JSON        # 完整评分数据（JSON）
│   │   ├── Status string            # ENUM
│   │   ├── CreatedAt timestamp
│   │   ├── UpdatedAt timestamp
│   │   └── DeletedAt *timestamp     # 软删除
│   │
│   └── TableName() string           // "evaluations"
│
├── user_po.go
│   ├── UserPO struct
│   │   ├── ID string
│   │   ├── Name string
│   │   ├── Email string (unique)
│   │   ├── PasswordHash string
│   │   ├── Avatar string
│   │   ├── TotalEvaluations int
│   │   ├── AverageScore float32
│   │   ├── LastEvaluationAt *timestamp
│   │   ├── CreatedAt, UpdatedAt
│   │   └── DeletedAt *timestamp
│   │
│   └── TableName() string           // "users"
│
└── feedback_po.go
    ├── FeedbackPO struct
    │   ├── ID string
    │   ├── EvaluationID string
    │   ├── FeedbackLevel string
    │   ├── FeedbackText string
    │   ├── FeedbackAudioURL string
    │   ├── DemoType string           # "word" / "sentence" / null
    │   ├── DemoContent string        # "apples" / "I like apples"
    │   ├── DemoAudioURL string
    │   ├── Status string             # "generating" / "completed" / "failed"
    │   ├── CreatedAt
    │   └── DeletedAt *timestamp
    │
    └── TableName() string           // "feedbacks"
```

**映射关系**：
- PO 与 MySQL 表完全对应
- JSON 字段存储复杂对象（ScoreDetails）
- 软删除字段（DeletedAt）

---

### 2.5 External 包（第三方 API）

#### 2.5.1 科大讯飞（xf/）

```
internal/external/xf/
│
├── client.go                         # 核心客户端
│   ├── XFClient struct
│   │   ├── AppID string
│   │   ├── APISecret string
│   │   ├── HTTPClient *http.Client
│   │   ├── Logger logger.Logger
│   │   └── retryPolicy *RetryPolicy
│   │
│   ├── NewXFClient()                # 工厂方法
│   ├── AssessSpeeches()             # 评测接口
│   │   - 生成认证信息
│   │   - 构建请求
│   │   - 处理响应
│   │   - 重试逻辑
│   │
│   └── Close()                      # 清理资源
│
├── speech_assess.go                  # 语音评测接口
│   ├── SpeechAssessRequest struct
│   │   ├── AudioData []byte         # 音频二进制
│   │   ├── Text string              # 目标文本
│   │   ├── AudioFormat string       # wav/mp3
│   │   └── SampleRate int           # 16000
│   │
│   ├── SpeechAssessResponse struct
│   │   ├── Code string              # 返回码
│   │   ├── Message string
│   │   ├── Data AssessmentData
│   │   └── SID string               # 会话 ID
│   │
│   ├── AssessmentData struct        # 讯飞返回的评分
│   │   ├── OverallScore int
│   │   ├── FluentScore int
│   │   ├── AccuracyScore int
│   │   ├── IntegrityScore int
│   │   ├── Words []WordAssessment
│   │   └── StandardText string
│   │
│   ├── WordAssessment struct
│   │   ├── Text string
│   │   ├── Score int
│   │   ├── BeginTime int
│   │   ├── EndTime int
│   │   ├── Phonemes []PhonemeAssessment
│   │   └── DetailScore DetailScore
│   │
│   └── PhonemeAssessment struct
│       ├── Phoneme string
│       ├── Score int
│       └── BeginTime int
│
├── models.go                         # 讯飞数据模型映射
│   ├── ToResponseModel()            # 讯飞 JSON → Response struct
│   └── validator.go                 # 响应校验
│
├── errors.go                         # 讯飞特定错误处理
│   ├── Error codes mapping
│   ├── IsNetworkError()
│   ├── IsAuthError()
│   ├── IsQuotaExceededError()
│   └── Translate to app errors
│
└── mocks/
    ├── mock_client.go               # Mockgen 生成的 mock
    └── fixtures.go                  # 测试数据
```

**关键设计**：
- 讯飞 API 响应完全解析，错误码映射
- 支持重试机制（超时、部分错误）
- 认证信息动态生成（基于时间戳）

---

#### 2.5.2 阿里云 TTS（aliyun/tts/）

```
internal/external/aliyun/tts/
│
├── client.go                         # CosyVoice 客户端
│   ├── CosyVoiceClient struct
│   │   ├── APIKey string
│   │   ├── RegionID string
│   │   ├── HTTPClient *http.Client
│   │   └── Logger logger.Logger
│   │
│   ├── NewCosyVoiceClient()         # 工厂方法
│   ├── Synthesize()                 # 语音合成接口
│   │   - 构建请求
│   │   - 调用 API
│   │   - 返回音频 URL
│   │
│   └── Close()
│
├── models.go                         # 数据模型
│   ├── SynthesisRequest struct
│   │   ├── Text string              # 要合成的文本
│   │   ├── Voice string             # 选择音色（"caisuoyin"等）
│   │   ├── Rate float32             # 语速（0.5-2.0）
│   │   └── Pitch float32            # 音调
│   │
│   ├── SynthesisResponse struct
│   │   ├── Code string
│   │   ├── Message string
│   │   ├── Data ResponseData
│   │   └── RequestID string
│   │
│   └── ResponseData struct
│       ├── AudioURL string          # 返回的音频 URL
│       ├── Duration float64
│       └── TaskID string
│
└── mocks/
    └── mock_client.go
```

**特点**：
- 返回音频 URL（不返回二进制，减少传输）
- 支持多个音色和参数调整
- 需要处理音频过长问题

---

#### 2.5.3 阿里云 OSS（aliyun/oss/）

```
internal/external/aliyun/oss/
│
├── client.go                         # OSS 客户端
│   ├── OSSClient struct
│   │   ├── Endpoint string
│   │   ├── AccessKeyID string
│   │   ├── AccessKeySecret string
│   │   ├── BucketName string
│   │   └── Logger logger.Logger
│   │
│   ├── NewOSSClient()               # 工厂方法
│   └── Close()
│
├── uploader.go                       # 上传核心逻辑
│   ├── UploadAudio()                # 上传二进制音频
│   │   - 生成 Object Key
│   │   - 流式上传
│   │   - 返回 URL
│   │
│   ├── UploadFile()                 # 上传文件
│   ├── GetURL()                     # 生成访问 URL（公网）
│   ├── SetAccessControl()           # 设置访问权限
│   │
│   └── Delete()                     # 删除对象
│
├── models.go                         # 数据模型
│   ├── UploadResult struct
│   │   ├── Key string               # OSS 对象 key
│   │   ├── URL string               # 公网访问 URL
│   │   ├── Size int64
│   │   └── ETag string
│   │
│   └── UploadOptions struct
│       ├── PublicRead bool
│       ├── TTL time.Duration        # URL 有效期
│       └── Metadata map[string]string
│
└── mocks/
    └── mock_client.go
```

**Key 生成规则**：
```
feedback_audio: oss/evaluations/{evaluation_id}/feedback.mp3
demo_audio:    oss/evaluations/{evaluation_id}/demo_{demo_type}_{content_hash}.mp3
original_audio: oss/audio/{user_id}/{timestamp}_{original_filename}
```

---

#### 2.5.4 通义千问（qwen/）

```
internal/external/qwen/
│
├── client.go                         # Qwen API 客户端
│   ├── QwenClient struct
│   │   ├── APIKey string
│   │   ├── Model string             # "qwen-max-turbo" / "qwen-max"
│   │   ├── HTTPClient *http.Client
│   │   └── Logger logger.Logger
│   │
│   ├── NewQwenClient()
│   ├── GenerateText()               # 文本生成接口
│   │   - 构建 messages
│   │   - 调用 API
│   │   - 流式或批量处理
│   │   - 错误处理
│   │
│   └── Close()
│
├── prompt.go                         # Prompt 模板管理
│   ├── PromptTemplate struct
│   │   ├── FeedbackLevel string
│   │   ├── Template string          # 模板内容
│   │   ├── Variables map[string]string
│   │   └── Constraints string       # 约束条件
│   │
│   ├── GetPromptForLevel()           # 按级别获取 Prompt
│   ├── BuildPrompt()                 # 替换变量
│   ├── GetPrompts() map[string]string # 获取所有 Prompt
│   │
│   └── 内置 Prompt：
│       ├── S 级：纯鼓励
│       ├── A 级：鼓励+诊断
│       ├── B 级：诊断+示范引导
│       └── C 级：完整示范+鼓励
│
├── models.go                         # 数据模型
│   ├── GenerateRequest struct
│   │   ├── Model string
│   │   ├── Messages []Message
│   │   ├── Temperature float32      # 创意程度
│   │   ├── TopP float32
│   │   └── MaxTokens int
│   │
│   ├── Message struct
│   │   ├── Role string              # "system" / "user"
│   │   └── Content string
│   │
│   ├── GenerateResponse struct
│   │   ├── Code string
│   │   ├── Message string
│   │   ├── Output OutputData
│   │   ├── Usage Usage
│   │   └── RequestID string
│   │
│   ├── OutputData struct
│   │   ├── Choices []Choice
│   │   └── TextChoices []TextChoice
│   │
│   └── Usage struct
│       ├── InputTokens int
│       └── OutputTokens int
│
└── mocks/
    └── mock_client.go
```

**Prompt 策略**：
- 集中管理在 prompt.go 的 map 中
- 每个级别的 Prompt 遵循 PRD 第 5 章的要求
- 支持动态变量替换（如 {target_text}, {problem_word}）

---

#### 2.5.5 外部服务统一接口

```
internal/external/interfaces.go

type ISpeechAssessor interface {
    AssessSpeeches(ctx context.Context, req *xf.SpeechAssessRequest) (*xf.SpeechAssessResponse, error)
}

type ITextToSpeech interface {
    Synthesize(ctx context.Context, req *tts.SynthesisRequest) (*tts.SynthesisResponse, error)
}

type IOSSUploader interface {
    UploadAudio(ctx context.Context, data []byte, opts *oss.UploadOptions) (*oss.UploadResult, error)
    GetURL(key string) string
    Delete(ctx context.Context, key string) error
}

type ILLMGenerator interface {
    GenerateText(ctx context.Context, req *qwen.GenerateRequest) (*qwen.GenerateResponse, error)
}

type IExternalServices interface {
    SpeechAssessor() ISpeechAssessor
    TextToSpeech() ITextToSpeech
    OSSUploader() IOSSUploader
    LLMGenerator() ILLMGenerator
}
```

**优势**：
- 所有外部服务通过接口依赖注入
- 便于单元测试（Mock 对象）
- 易于替换实现

---

### 2.6 Cache 层（缓存）

```
internal/cache/
│
├── redis/
│   ├── client.go                     # Redis 连接池
│   │   ├── NewRedisClient()
│   │   └── Hooks 配置（日志、监控）
│   │
│   ├── keys.go                       # Redis Key 管理
│   │   ├── EvaluationKey(evaluationID string)
│   │   ├── UserStatsKey(userID string)
│   │   ├── FeedbackTextKey(evaluationID string)
│   │   ├── DemoAudioKey(word string)
│   │   └── AudioURLKey(audioID string)
│   │
│   └── commands.go                   # Redis 操作封装
│       ├── Set, Get, Del
│       ├── Expire 设置过期时间
│       └── TTL 定义
│
├── evaluation_cache.go               # 评测缓存业务
│   ├── CacheEvaluation()             # 缓存完整评测结果
│   ├── GetCachedEvaluation()         # 从缓存读取
│   ├── TTL: 24 小时
│   └── InvalidateEvaluation()
│
├── feedback_cache.go                 # 反馈缓存
│   ├── CacheFeedbackText()           # 缓存反馈文本
│   ├── CacheFeedbackAudio()          # 缓存反馈音频 URL
│   ├── TTL: 7 天
│   └── GetCachedFeedback()
│
├── audio_cache.go                    # 音频 URL 缓存
│   ├── CacheAudioURL()               # 缓存示范音频 URL
│   ├── GetCachedDemoAudio()          # 获取常用词示范
│   ├── TTL: 30 天
│   └── PreloadCommonWords()          # 预加载高频词
│
└── user_cache.go                     # 用户数据缓存
    ├── CacheUserStats()              # 缓存用户统计
    ├── GetCachedStats()
    ├── TTL: 1 小时
    └── InvalidateUserStats()
```

**缓存策略**：
- Cache-Aside 模式（读时检查，写时更新）
- 分级 TTL（热数据短，冷数据长）
- 支持预加载（高频词示范）

---

### 2.7 Queue 包（异步任务）

```
internal/queue/
│
├── producer.go                       # 任务生产者
│   ├── PublishFeedbackGenerationTask()
│   ├── PublishAudioGenerationTask()
│   ├── PublishAudioUploadTask()
│   │
│   └── Task struct
│       ├── ID string                 # 任务 ID
│       ├── Type string               # feedback_generation / ...
│       ├── EvaluationID string       # 关联的评测 ID
│       ├── Payload map[string]interface{}
│       ├── RetryCount int
│       ├── CreatedAt time.Time
│       └── TTL time.Duration         # 任务过期时间
│
├── consumer.go                       # 任务消费者
│   ├── StartWorker()                # 启动消费 goroutine
│   ├── ProcessTask()                # 处理单个任务
│   ├── HandleError()                # 处理失败（重试/死信队列）
│   ├── WorkerPool size: 10 workers
│   └── Graceful shutdown
│
├── tasks/
│   ├── feedback_generation.go       # 生成反馈任务
│   │   ├── FeedbackGenerationTask struct
│   │   │   ├── EvaluationID string
│   │   │   ├── FeedbackLevel string
│   │   │   ├── ProblematicWords []string
│   │   │   ├── GeneratedText string
│   │   │   └── Status string
│   │   │
│   │   └── Execute()                # 执行任务逻辑
│   │       1. 调用 LLM 生成文本
│   │       2. 校验质量
│   │       3. 保存到 DB
│   │       4. 触发 TTS 任务
│   │
│   ├── audio_generation.go          # 生成音频任务
│   │   ├── AudioGenerationTask struct
│   │   │   ├── EvaluationID string
│   │   │   ├── AudioType string     # feedback / demo
│   │   │   ├── Content string       # 要合成的文本
│   │   │   └── GeneratedURL string
│   │   │
│   │   └── Execute()                # 执行任务逻辑
│   │       1. 调用 TTS API
│   │       2. 触发上传任务
│   │
│   ├── audio_upload.go              # 上传音频任务
│   │   ├── AudioUploadTask struct
│   │   │   ├── EvaluationID string
│   │   │   ├── AudioType string
│   │   │   ├── AudioURL string      # TTS 返回的 URL
│   │   │   └── FinalCDNURL string   # 上传后的 CDN URL
│   │   │
│   │   └── Execute()                # 执行任务逻辑
│   │       1. 下载音频
│   │       2. 上传到 OSS
│   │       3. 更新数据库
│   │
│   └── notification.go              # 通知任务（可选）
│       └── 推送消息到前端 WebSocket
│
└── processor.go                      # 任务处理器注册
    ├── RegisterProcessors()         # 注册所有任务类型的处理器
    ├── ProcessFeedbackGeneration()
    ├── ProcessAudioGeneration()
    └── ProcessAudioUpload()
```

**工作流**：
```
[Handler] → PublishFeedbackGenerationTask
            ↓
        [Redis Queue] 存储任务
            ↓
[Consumer Worker] → 取出任务
                    ↓
                Execute FeedbackGenerationTask
                    ↓
                发布 AudioGenerationTask
                    ↓
                Execute AudioGenerationTask
                    ↓
                发布 AudioUploadTask
                    ↓
                Execute AudioUploadTask
                    ↓
                [DB] 标记评测为 completed
```

**特点**：
- 异步执行（不阻塞 API 响应）
- 支持重试（指数退避）
- 支持死信队列（失败任务）

---

### 2.8 Pkg 包（通用工具）

```
internal/pkg/
│
├── logger/                           # 日志库
│   ├── logger.go
│   │   ├── Logger interface
│   │   ├── Error(msg, fields...)
│   │   ├── Warn(msg, fields...)
│   │   ├── Info(msg, fields...)
│   │   └── Debug(msg, fields...)
│   │
│   ├── fields.go                     # 日志字段定义
│   │   ├── WithUserID(userID)
│   │   ├── WithEvaluationID(id)
│   │   ├── WithError(err)
│   │   └── WithRequestID(id)
│   │
│   └── zap_logger.go                # Zap 实现（生产推荐）
│
├── db/                              # 数据库工具
│   ├── mysql.go
│   │   ├── NewMySQLConn()           # 创建连接池
│   │   ├── WithRetry()              # 重试机制
│   │   └── HealthCheck()
│   │
│   ├── transaction.go               # 事务管理
│   │   ├── WithTx()                 # 事务执行包装器
│   │   ├── Commit / Rollback
│   │   └── Savepoint 支持
│   │
│   └── query_builder.go             # SQL 构建器（可选）
│
├── errors/                          # 错误处理
│   ├── errors.go
│   │   ├── AppError struct
│   │   │   ├── Code string         # 错误码（E0001等）
│   │   │   ├── Message string      # 用户友好消息
│   │   │   ├── InternalMsg string  # 内部日志消息
│   │   │   ├── StatusCode int      # HTTP 状态码
│   │   │   └── Err error           # 原始错误
│   │   │
│   │   ├── NewAppError()
│   │   ├── IsAppError()
│   │   └── UnwrapAppError()
│   │
│   ├── codes.go                     # 错误码定义
│   │   ├── E0001 = "Invalid Audio Format"
│   │   ├── E0002 = "Audio Too Long"
│   │   ├── E0003 = "Speech Assessment Failed"
│   │   ├── E0004 = "Feedback Generation Failed"
│   │   └── ...
│   │
│   └── handler.go                   # 错误转换
│       └── ErrorToResponse()        # AppError → HTTP 响应
│
├── validator/                       # 参数验证
│   └── validator.go
│       ├── ValidateAudioFile()
│       ├── ValidateText()
│       ├── ValidateUserID()
│       └── 使用 go-playground/validator
│
├── audio/                           # 音频处理
│   ├── converter.go
│   │   ├── ConvertMP3ToWAV()
│   │   ├── ConvertBase64ToBytes()
│   │   └── ExtractAudioInfo()      # 时长、采样率等
│   │
│   ├── validator.go
│   │   ├── ValidateFormat()
│   │   ├── ValidateSize()          # ≤ 10 MB
│   │   ├── ValidateDuration()      # ≤ 60 s
│   │   └── ValidateSampleRate()    # >= 16000 Hz
│   │
│   └── processor.go
│       ├── NormalizeAudio()         # 标准化采样率
│       └── CompressAudio()          # 压缩（可选）
│
├── http/                            # HTTP 工具
│   ├── response.go
│   │   ├── SuccessResponse struct
│   │   │   ├── Code int = 200
│   │   │   ├── Message string
│   │   │   └── Data interface{}
│   │   │
│   │   ├── ErrorResponse struct
│   │   │   ├── Code int (非200)
│   │   │   ├── Message string
│   │   │   └── Error string (debug模式)
│   │   │
│   │   ├── SendSuccess()
│   │   ├── SendError()
│   │   └── SendPaginated()
│   │
│   ├── request.go
│   │   ├── GetUserIDFromContext()
│   │   ├── GetRequestID()
│   │   └── ParseMultipartForm()
│   │
│   └── client.go
│       ├── NewHTTPClient()         # 带重试的 client
│       ├── Do() 方法 (自动重试)
│       └── Timeout 配置
│
├── retry/                           # 重试机制
│   └── retry.go
│       ├── ExponentialBackoff()    # 指数退避
│       ├── MaxRetries: 3
│       ├── InitialInterval: 100ms
│       └── MaxInterval: 30s
│
├── convert/                         # 类型转换
│   └── convert.go
│       ├── ToInt()
│       ├── ToString()
│       ├── ToFloat()
│       └── SafeConvert()
│
└── uuid/                            # ID 生成
    └── uuid.go
        ├── NewUUID()               # 生成 UUID
        ├── NewEvaluationID()       # eval_xxx 格式
        ├── NewUserID()             # user_xxx 格式
        └── NewTaskID()             # task_xxx 格式
```

**设计原则**：
- 每个工具都是可复用的、无业务逻辑的
- 依赖注入接口（Logger, HTTPClient）
- 错误处理统一，错误码标准化

---

### 2.9 API 路由层

```
api/
│
├── routes.go                         # 路由注册主函数
│   ├── SetupRoutes(engine *gin.Engine)
│   └── 注册 v1 路由组
│
└── v1/
    ├── evaluation.go                 # 评测相关路由
    │   ├── POST /api/v1/voice/evaluate           # 提交评测
    │   ├── GET  /api/v1/evaluations              # 获取历史
    │   ├── GET  /api/v1/evaluations/{id}         # 获取详情
    │   ├── POST /api/v1/evaluations/{id}/retry   # 重新评测
    │   └── 处理逻辑委托给 handler.evaluation
    │
    ├── feedback.go
    │   ├── GET /api/v1/feedback/{id}/audio       # 获取反馈音频
    │   └── GET /api/v1/demo/{word}               # 获取示范音频
    │
    ├── user.go
    │   ├── GET /api/v1/user/profile
    │   └── GET /api/v1/user/stats
    │
    └── health.go
        └── GET /api/v1/health
```

**关键设计**：
- 路由与 handler 一一对应
- 中间件链：认证 → CORS → 日志 → 错误处理
- 按资源组织路由（RESTful）

---

### 2.10 数据库设计

```
internal/database/schema.sql

-- 用户表
CREATE TABLE users (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    avatar VARCHAR(255),
    total_evaluations INT DEFAULT 0,
    average_score FLOAT DEFAULT 0,
    last_evaluation_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    INDEX idx_email (email),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 评测记录表
CREATE TABLE evaluations (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    target_text VARCHAR(500) NOT NULL,
    recognized_text VARCHAR(500),
    overall_score INT,
    accuracy_score INT,
    fluency_score INT,
    integrity_score INT,
    feedback_level ENUM('S', 'A', 'B', 'C'),
    score_details JSON,                    # 完整评分数据
    status ENUM('pending', 'completed', 'failed') DEFAULT 'pending',
    error_message VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_feedback_level (feedback_level),
    INDEX idx_created_at (created_at),
    INDEX idx_status (status)
) ENGINE=InnoDB CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 反馈表
CREATE TABLE feedbacks (
    id VARCHAR(36) PRIMARY KEY,
    evaluation_id VARCHAR(36) NOT NULL UNIQUE,
    feedback_level ENUM('S', 'A', 'B', 'C'),
    feedback_text VARCHAR(500),
    feedback_audio_url VARCHAR(500),
    demo_type ENUM('word', 'sentence', 'paragraph') NULL,
    demo_content VARCHAR(500),
    demo_audio_url VARCHAR(500),
    status ENUM('generating', 'completed', 'failed') DEFAULT 'generating',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    FOREIGN KEY (evaluation_id) REFERENCES evaluations(id),
    INDEX idx_evaluation_id (evaluation_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 用户统计表（冗余字段加速查询）
CREATE TABLE user_stats (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL UNIQUE,
    total_count INT DEFAULT 0,
    s_level_count INT DEFAULT 0,
    a_level_count INT DEFAULT 0,
    b_level_count INT DEFAULT 0,
    c_level_count INT DEFAULT 0,
    average_score FLOAT DEFAULT 0,
    last_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

**关键设计**：
- 软删除（deleted_at）支持恢复
- JSON 字段存储复杂结构（score_details）
- 索引优化查询性能
- 冗余统计表（user_stats）加速聚合查询

---

## 三、分层关系与数据流

### 3.1 发音评测完整流程

```
┌─────────────────────────────────────────────────────────────┐
│ [1] HTTP Handler                                             │
│     SubmitAudioForEvaluation(ctx, req)                      │
│     - 解析 multipart/form-data（音频）                       │
│     - 参数验证 (validator)                                   │
│     - 返回 202 Accepted                                      │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ [2] Service Layer (EvaluationService)                        │
│     Evaluate(ctx, req)                                       │
│     - 调用 audio.processor.ValidateAudio()                   │
│     - 调用 external.xf.AssessSpeeches()  ← 同步调用          │
│     - 调用 scorer.ScoreAndClassify()                        │
│     - 调用 repository.Create()           ← 保存初始记录      │
│     - 发布 FeedbackGenerationTask 到 Queue                  │
│     - 返回基础评测结果                                        │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ [3] Repository Layer                                         │
│     evaluation.Create(ctx, domainEvaluation)                │
│     - INSERT INTO evaluations (...)                         │
│     - 返回 evaluation_id                                    │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ [4] Cache Layer                                              │
│     evaluation_cache.CacheEvaluation(...)                   │
│     - 设置 Redis key: evaluation:{id}                       │
│     - TTL: 24 小时                                           │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ [5] Queue (Async Task)                                       │
│     PublishFeedbackGenerationTask(...)                      │
│     - 发布任务到 Redis Queue                                │
└────────────────────┬────────────────────────────────────────┘
                     ↓
         ┌───────────────────────┐
         │  [Worker Goroutine]   │
         │ 处理 FeedbackGenTask   │
         └───────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ [6] Service: FeedbackGenerator                              │
│     GenerateFeedbackText(ctx, evaluation)                   │
│     - 调用 levels.GetPromptForLevel()                       │
│     - 调用 external.qwen.GenerateText()                     │
│     - 调用 validator.ValidateFeedback()                     │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ [7] Service: AudioProcessor                                 │
│     ├─ TTS 反馈文本 → 反馈音频                               │
│     │  Synthesize(feedbackText)                            │
│     │  ↓ external.aliyun.tts.Synthesize()                  │
│     │                                                       │
│     ├─ TTS 问题单词/整句 → 示范音频                          │
│     │  Synthesize(problemWord or fullSentence)            │
│     │  ↓ external.aliyun.tts.Synthesize()                  │
│     │                                                       │
│     └─ 上传到 OSS → 获取 CDN URL                            │
│        UploadToOSS(audioBuffer)                           │
│        ↓ external.aliyun.oss.UploadAudio()                 │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ [8] Repository: Update Feedback                              │
│     feedback.Create(...) / evaluation.Update(...)           │
│     - 保存 feedback_text, audio_url 等                      │
│     - 更新 evaluation.status = 'completed'                 │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│ [9] Cache Invalidation (可选)                                │
│     - 删除 Redis 中的 pending 标记                           │
│     - 保留评测结果缓存 (24h)                                 │
└────────────────────┬────────────────────────────────────────┘
                     ↓
          [前端轮询或 WebSocket]
          GET /api/v1/evaluations/{id}
          → 显示完整评测结果
```

### 3.2 分层之间的调用关系

```
HTTP Request
    ↓
┌─────────────┐
│   Handler   │  ← 解析请求，验证参数
└──────┬──────┘
       ↓
┌──────────────┐
│   Service    │  ← 核心业务逻辑
└──────┬───────┘
       ├─→ ┌──────────────┐
       │   │ Repository   │ ← CRUD 操作
       │   └──────────────┘
       │
       ├─→ ┌──────────────┐
       │   │   Cache      │ ← 数据缓存
       │   └──────────────┘
       │
       ├─→ ┌──────────────┐
       │   │   External   │ ← 第三方 API
       │   └──────────────┘
       │
       ├─→ ┌──────────────┐
       │   │   Queue      │ ← 异步任务
       │   └──────────────┘
       │
       └─→ ┌──────────────┐
           │     Pkg      │ ← 通用工具
           └──────────────┘
                    ↓
              HTTP Response
```

---

## 四、技术栈选择

### 4.1 核心依赖

```go
// go.mod 关键依赖

require (
    github.com/gin-gonic/gin v1.9.0              // Web 框架
    github.com/gorm.io/gorm v1.25.0              // ORM
    github.com/gorm.io/driver/mysql v1.25.0      // MySQL 驱动
    github.com/redis/go-redis/v9 v9.0.0          // Redis 客户端
    
    github.com/google/uuid v1.3.0                // UUID 生成
    github.com/go-playground/validator/v10 v10.11.0  // 参数验证
    github.com/joho/godotenv v1.5.1              // 环境变量
    
    go.uber.org/zap v1.24.0                     // 日志库
    go.uber.org/dig v1.16.0                     // 依赖注入
    
    github.com/aliyun/aliyun-oss-go-sdk v2.0.0   // 阿里云 OSS
    github.com/tencentcloud/tencentcloud-sdk-go/v3 v3.1.0  // 讯飞 API
    github.com/go-resty/resty/v2 v2.7.0         // HTTP 客户端
    
    github.com/stretchr/testify v1.8.0           // 测试框架
    github.com/golang/mock v1.6.0                // Mock 工具
    github.com/testcontainers/testcontainers-go v0.17.0  // 容器测试
)
```

### 4.2 项目规范

```
- 遵循 Go Code Review Comments
- 使用 go fmt 格式化
- 单元测试覆盖率 ≥ 70%
- 集成测试覆盖关键流程
- Dockerfile 打包，支持 K8s 部署
```

---

## 五、关键设计决策

| 决策 | 原因 |
|------|------|
| 分层架构 | 代码解耦，便于测试和维护 |
| Service 包含业务逻辑 | 避免 handler 过重，易于单元测试 |
| 外部 API 封装 | 便于替换、Mock 测试、版本升级 |
| 异步任务队列 | 不阻塞 API 响应，提升用户体验 |
| Redis 缓存 | 减少数据库压力，加速热数据访问 |
| 错误码标准化 | 统一错误处理，便于调试和日志分析 |
| 接口依赖注入 | 支持 Mock，便于单元测试 |

---

## 六、目录规模估计

```
总行数：~15,000 - 20,000 行 Go 代码（除去测试）
  - Handler: ~2,000 行
  - Service: ~5,000 行
  - Repository: ~2,000 行
  - External: ~3,000 行
  - Pkg: ~3,000 行

测试代码：~5,000 - 8,000 行

配置文件：~500 行
  - YAML, SQL, Dockerfile

总计：~20,000 - 30,000 行
```

---

## 七、部署架构

```
┌───────────────────────────────────────┐
│     Kubernetes Cluster                │
├───────────────────────────────────────┤
│                                       │
│  ┌──────────────────────────────────┐ │
│  │   Pronunciation Service Pod      │ │
│  │  (Go + Gin, 3 replicas)         │ │
│  └──────────────────────────────────┘ │
│                ↓                       │
│  ┌──────────────────────────────────┐ │
│  │   MySQL Database (RDS)           │ │
│  │  (Master-Slave 主从复制)          │ │
│  └──────────────────────────────────┘ │
│                ↓                       │
│  ┌──────────────────────────────────┐ │
│  │   Redis Cluster                  │ │
│  │  (缓存 + 任务队列)               │ │
│  └──────────────────────────────────┘ │
│                ↓                       │
│  ┌──────────────────────────────────┐ │
│  │   Worker Pod (异步任务处理)      │ │
│  │  (消费 Redis Queue)              │ │
│  └──────────────────────────────────┘ │
│                ↓                       │
└───────────────────────────────────────┘
         ↓         ↓         ↓
    ┌─────────┐ ┌───────┐ ┌──────┐
    │ 讯飞 API│ │阿里云 │ │通义  │
    │        │ │OSS/TTS│ │千问  │
    └─────────┘ └───────┘ └──────┘
```

---

## 总结

这个目录结构遵循：
1. **分层架构**（Handler → Service → Repository）
2. **清晰的职责划分**（每个包只做一件事）
3. **易于扩展**（新增功能只需加文件）
4. **企业级规范**（错误处理、日志、缓存、异步等）
5. **可测试性**（接口依赖注入、Mock 支持）
6. **第三方 API 隔离**（external 包集中管理）

可直接用于毕业设计，并具有产品级别的工程化水准！