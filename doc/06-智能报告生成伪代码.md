# 【阶段 5：AI 学习报告模块核心流程伪代码】

---

## 一、接口：POST /api/v1/report/generate

**功能**：用户触发生成阶段性学习报告，后端异步汇总数据并生成详细报告

**流程类型**：同步 API + 异步报告生成

---

### 1.1 伪代码流程

```
流程：POST /api/v1/report/generate
├─ 【同步阶段】
│  ├─ 步骤 1：接收 HTTP 请求
│  │  ├─ 请求体参数：
│  │  │  ├─ report_type（字符串）：["weekly", "monthly", "custom"]
│  │  │  ├─ start_date（字符串 YYYY-MM-DD）
│  │  │  ├─ end_date（字符串 YYYY-MM-DD）
│  │  │  ├─ include_recommendation（布尔值，可选，默认 true）
│  │  │  └─ focus_areas（字符串数组，可选）：["pronunciation", "fluency", "completeness"]
│  │  └─ 异常点：report_type 为空 → 返回 400 Bad Request
│  │
│  ├─ 步骤 2：身份验证
│  │  ├─ 从 HTTP Header 获取 Authorization Token
│  │  ├─ 调用 TokenService.ValidateToken(token)
│  │  └─ 异常点：Token 无效或过期 → 返回 401 Unauthorized
│  │
│  ├─ 步骤 3：提取用户 ID
│  │  ├─ user_id = Token.解析并获取(user_id)
│  │  └─ 异常点：Token 中缺少 user_id → 返回 401
│  │
│  ├─ 步骤 4：参数校验
│  │  ├─ 检查 report_type 是否为有效值
│  │  │  └─ 异常点：非法值 → 返回 400
│  │  ├─ 检查日期格式
│  │  │  └─ 异常点：格式错误 → 返回 400
│  │  ├─ 检查 start_date <= end_date
│  │  │  └─ 异常点：start_date > end_date → 返回 400
│  │  ├─ 检查日期范围 ≤ 1 年
│  │  │  └─ 异常点：超过 1 年 → 返回 400
│  │  ├─ 检查 focus_areas 是否为有效值
│  │  │  └─ 异常点：包含非法值 → 返回 400
│  │  └─ 异常点：参数校验失败 → 返回 400
│  │
│  ├─ 步骤 5：确定日期范围
│  │  ├─ 如果 report_type == "weekly"：
│  │  │  ├─ start_date = 当前日期所在周的周一
│  │  │  └─ end_date = 当前日期所在周的周日
│  │  ├─ 如果 report_type == "monthly"：
│  │  │  ├─ start_date = 当前月的第一天
│  │  │  └─ end_date = 当前月的最后一天
│  │  └─ 如果 report_type == "custom"：
│  │     └─ 使用请求中的 start_date 和 end_date
│  │
│  ├─ 步骤 6：检查是否已有同期报告
│  │  ├─ 调用 Database.GetExistingReport(user_id, report_type, start_date, end_date)
│  │  ├─ 如果已存在且 status == "success"：
│  │  │  ├─ 返回响应，建议使用已有报告或重新生成
│  │  │  └─ 返回 200，data = { report_id: existing_id, message: "已存在相同期间报告" }
│  │  └─ 异常点：查询失败 → 继续（不中断）
│  │
│  ├─ 步骤 7：检查数据量是否足够
│  │  ├─ 调用 Database.CountUserActivityInPeriod(user_id, start_date, end_date)
│  │  ├─ activity_count = chat_count + eval_count
│  │  ├─ 如果 activity_count < 3：
│  │  │  └─ 返回响应，告知数据量不足
│  │  │     返回 200，data = { message: "数据不足，至少需要 3 条学习记录" }
│  │  └─ 继续
│  │
│  ├─ 步骤 8：速率限制检查
│  │  ├─ 调用 RateLimiter.CheckLimit(user_id, "report_generate", 限制=5/天)
│  │  └─ 异常点：超过限制 → 返回 429 Too Many Requests
│  │
│  ├─ 步骤 9：生成报告 ID
│  │  ├─ report_id = "report_" + timestamp + "_" + random_string
│  │  └─ 生成方式：UUID 或 Snowflake ID
│  │
│  ├─ 步骤 10：创建初始报告状态记录
│  │  ├─ 构建报告对象：
│  │  │  ├─ report_id
│  │  │  ├─ status = "generating"
│  │  │  ├─ user_id
│  │  │  ├─ report_type
│  │  │  ├─ start_date
│  │  │  ├─ end_date
│  │  │  ├─ progress = 0
│  │  │  ├─ created_at = now
│  │  │  ├─ updated_at = now
│  │  │  ├─ include_recommendation
│  │  │  ├─ focus_areas
│  │  │  └─ estimated_completion_seconds = 30
│  │  ├─ 调用 Cache.SetReportStatus(report_id, 报告对象)
│  │  │  ├─ 存储位置：Redis (TTL = 2 小时)
│  │  │  └─ 异常点：Redis 连接失败 → 返回 503 Service Unavailable
│  │  └─ 同时保存到数据库（异步）
│  │
│  ├─ 步骤 11：将任务推送到异步队列
│  │  ├─ 调用 Queue.PushTask(报告对象)
│  │  │  ├─ 存储位置：Redis List (ReportQueue)
│  │  │  ├─ 队列键：task:queue:report
│  │  │  ├─ 优先级：normal
│  │  │  └─ 异常点：队列满 → 返回 503
│  │  └─ 验证推送成功
│  │
│  ├─ 步骤 12：构建响应体
│  │  ├─ 响应结构：
│  │  │  ├─ code = 200
│  │  │  ├─ message = "success"
│  │  │  └─ data = {
│  │  │      report_id: "report_20240115_abc123def456",
│  │  │      status: "generating",
│  │  │      report_type,
│  │  │      start_date,
│  │  │      end_date,
│  │  │      progress: 0,
│  │  │      message: "报告生成中，请稍候...",
│  │  │      estimated_seconds: 30
│  │  │    }
│  │  └─ HTTP 状态码：200 OK
│  │
│  └─ 步骤 13：返回响应
│     └─ 返回 JSON 响应给客户端
│
├─ 【异步阶段】（由 Worker Pool 处理，不阻塞主流程）
│  │
│  ├─ Worker 线程从队列中拉取任务
│  │  ├─ 调用 Queue.PopTask("report", timeout=30s)
│  │  └─ 返回报告对象
│  │
│  ├─ 步骤 A1：查询评测数据
│  │  ├─ 更新报告状态：progress = 10%, current_stage = "fetching_eval_data"
│  │  ├─ 调用 Database.GetEvalRecordsByPeriod(user_id, start_date, end_date)
│  │  ├─ 返回：eval_records[]
│  │  │  ├─ 每条包含：eval_id、overall_score、pronunciation_score、fluency_score、
│  │  │  │            integrity_score、text_id、reference_text、created_at
│  │  │  └─ 异常点：查询失败 → status = "failed", error = "评测数据查询失败"
│  │  └─ 异常处理：没有评测数据 → eval_records = []
│  │
│  ├─ 步骤 A2：查询对话数据
│  │  ├─ 更新报告状态：progress = 20%
│  │  ├─ 调用 Database.GetChatRecordsByPeriod(user_id, start_date, end_date)
│  │  ├─ 返回：chat_records[]
│  │  │  ├─ 每条包含：chat_id、session_id、user_text、ai_text、created_at、
│  │  │  │            duration_ms、feedback_rating
│  │  │  └─ 异常点：查询失败 → status = "failed"
│  │  └─ 异常处理：没有对话数据 → chat_records = []
│  │
│  ├─ 步骤 A3：计算评测统计
│  │  ├─ 更新报告状态：progress = 30%, current_stage = "analyzing_eval"
│  │  ├─ 构建评测分析对象：
│  │  │  ├─ 总体统计：
│  │  │  │  ├─ total_eval_count = len(eval_records)
│  │  │  │  ├─ avg_overall_score = mean(overall_score)
│  │  │  │  ├─ avg_pronunciation = mean(pronunciation_score)
│  │  │  │  ├─ avg_fluency = mean(fluency_score)
│  │  │  │  ├─ avg_integrity = mean(integrity_score)
│  │  │  │  ├─ best_score = max(overall_score)
│  │  │  │  ├─ worst_score = min(overall_score)
│  │  │  │  └─ score_trend = 计算分数趋势（上升/下降/平稳）
│  │  │  │
│  │  │  ├─ 分数分布：
│  │  │  │  ├─ excellent_count = count(score >= 90)
│  │  │  │  ├─ good_count = count(80 <= score < 90)
│  │  │  │  ├─ fair_count = count(70 <= score < 80)
│  │  │  │  └─ needs_improvement_count = count(score < 70)
│  │  │  │
│  │  │  ├─ 音素级分析：
│  │  │  │  ├─ 合并所有 eval_records 中的 phonemes
│  │  │  │  ├─ 统计每个音素的：
│  │  │  │  │  ├─ 出现次数
│  │  │  │  │  ├─ 平均分
│  │  │  │  │  ├─ 最高分
│  │  │  │  │  └─ 最低分
│  │  │  │  ├─ 识别困难音素：score < 70 的音素
│  │  │  │  └─ 掌握良好音素：score >= 85 的音素
│  │  │  │
│  │  │  ├─ 文本难度分析：
│  │  │  │  ├─ 统计每个 text_id 的：
│  │  │  │  │  ├─ 练习次数
│  │  │  │  │  ├─ 平均分
│  │  │  │  │  ├─ 学习状态
│  │  │  │  │  └─ 最后练习时间
│  │  │  │  ├─ 最易掌握文本：avg_score >= 85
│  │  │  │  └─ 最需改善文本：avg_score < 70
│  │  │  │
│  │  │  └─ 异常处理：计算失败 → 使用默认值，继续
│  │  │
│  │  └─ 保存到中间变量：eval_analysis
│  │
│  ├─ 步骤 A4：计算对话统计
│  │  ├─ 更新报告状态：progress = 40%, current_stage = "analyzing_chat"
│  │  ├─ 构建对话分析对象：
│  │  │  ├─ 总体统计：
│  │  │  │  ├─ total_chat_count = len(chat_records)
│  │  │  │  ├─ total_session_count = count(distinct session_id)
│  │  │  │  ├─ total_duration_ms = sum(duration_ms)
│  │  │  │  ├─ avg_duration_ms = mean(duration_ms)
│  │  │  │  ├─ avg_chat_per_session = total_chat_count / total_session_count
│  │  │  │  ├─ avg_feedback_rating = mean(feedback_rating) （可能为 null）
│  │  │  │  └─ engagement_score = 计算用户参与度（基于频率和时长）
│  │  │  │
│  │  │  ├─ 对话频率分析：
│  │  │  │  ├─ daily_avg = total_chat_count / (end_date - start_date + 1)
│  │  │  │  ├─ most_active_date = 对话最多的日期
│  │  │  │  ├─ least_active_date = 对话最少的日期
│  │  │  │  └─ consistency_score = 学习一致性评分（基于每日学习情况）
│  │  │  │
│  │  │  ├─ 话题分析（如果有）：
│  │  │  │  ├─ 统计各个话题的对话数
│  │  │  │  ├─ 最常讨论话题
│  │  │  │  └─ 话题多样性
│  │  │  │
│  │  │  └─ 异常处理：计算失败 → 使用默认值
│  │  │
│  │  └─ 保存到中间变量：chat_analysis
│  │
│  ├─ 步骤 A5：计算学习进度
│  │  ├─ 更新报告状态：progress = 50%, current_stage = "calculating_progress"
│  │  ├─ 构建学习进度对象：
│  │  │  ├─ 总体进度：
│  │  │  │  ├─ learning_hours = total_duration_ms / 3600000
│  │  │  │  ├─ text_mastery_count = count(learning_status == "mastered")
│  │  │  │  ├─ text_in_progress_count = count(learning_status == "learning")
│  │  │  │  ├─ overall_progress_pct = (text_mastery_count) / (total_texts) * 100%
│  │  │  │  └─ expected_mastery_date = 预估完全掌握日期（基于学习速度）
│  │  │  │
│  │  │  ├─ 能力评估：
│  │  │  │  ├─ pronunciation_level = 根据 avg_pronunciation 评定等级
│  │  │  │  │  ├─ ≥ 90：Expert
│  │  │  │  │  ├─ 80-89：Advanced
│  │  │  │  │  ├─ 70-79：Intermediate
│  │  │  │  │  └─ < 70：Beginner
│  │  │  │  ├─ fluency_level
│  │  │  │  ├─ integrity_level
│  │  │  │  └─ 综合能力等级
│  │  │  │
│  │  │  ├─ 进度对比：
│  │  │  │  ├─ 与上周期对比：improvement_pct = (current_score - previous_score) / previous_score
│  │  │  │  ├─ 趋势判断：↑ 上升 / ↓ 下降 / ≈ 平稳
│  │  │  │  └─ 排名信息（可选）：用户在同级别用户中的排名
│  │  │  │
│  │  │  └─ 异常处理：计算失败 → 使用默认值
│  │  │
│  │  └─ 保存到中间变量：progress_analysis
│  │
│  ├─ 步骤 A6：生成发音改善分析
│  │  ├─ 更新报告状态：progress = 60%, current_stage = "analyzing_improvement"
│  │  ├─ 构建改善分析对象：
│  │  │  ├─ 改善最明显的方面：
│  │  │  │  ├─ 对比前后时期的分数变化
│  │  │  │  ├─ pronunciation_improvement：改善幅度最大的方面
│  │  │  │  ├─ fluency_improvement
│  │  │  │  └─ integrity_improvement
│  │  │  │
│  │  │  ├─ 改善最快的音素（Top 5）：
│  │  │  │  ├─ 统计音素分数变化
│  │  │  │  └─ 排序得出进步最大的 5 个
│  │  │  │
│  │  │  ├─ 仍需改善的音素（Top 5）：
│  │  │  │  ├─ 筛选 score < 70 的音素
│  │  │  │  ├─ 按出现频率排序
│  │  │  │  └─ 返回前 5 个
│  │  │  │
│  │  │  ├─ 掌握的新音素（本期新出现且 score >= 85）
│  │  │  │  ├─ 统计与前期对比新学的音素
│  │  │  │  └─ 列出前 10 个
│  │  │  │
│  │  │  └─ 异常处理：计算失败 → 使用空数组
│  │  │
│  │  └─ 保存到中间变量：improvement_analysis
│  │
│  ├─ 步骤 A7：生成学习建议（如果 include_recommendation == true）
│  │  ├─ 更新报告状态：progress = 70%, current_stage = "generating_recommendations"
│  │  ├─ 构建建议对象：
│  │  │  ├─ 针对困难音素的建议：
│  │  │  │  ├─ 对每个困难音素（score < 70）：
│  │  │  │  │  ├─ 查询包含该音素的相关学习文本
│  │  │  │  │  ├─ 生成建议：
│  │  │  │  │  │  └─ "{音素} 发音困难，建议反复练习这些文本："
│  │  │  │  │  │     "[推荐的文本列表]"
│  │  │  │  │  └─ 附加建议链接
│  │  │  │  └─ 返回前 3 个困难音素的建议
│  │  │  │
│  │  │  ├─ 针对薄弱方面的建议：
│  │  │  │  ├─ 如果 avg_fluency < 75：
│  │  │  │  │  └─ 建议：加强对话练习，提升整体流利度
│  │  │  │  ├─ 如果 avg_integrity < 75：
│  │  │  │  │  └─ 建议：完整朗读长段落，提升准确度
│  │  │  │  └─ 其他类似判断
│  │  │  │
│  │  │  ├─ 针对学习方法的建议：
│  │  │  │  ├─ 如果 consistency_score < 60：
│  │  │  │  │  └─ 建议：保持每日学习习惯，建议日均至少 30 分钟
│  │  │  │  ├─ 如果 engagement_score > 80：
│  │  │  │  │  └─ 建议：保持当前学习热情，进阶到更高难度内容
│  │  │  │  └─ 其他类似判断
│  │  │  │
│  │  │  ├─ 针对focus_areas的专项建议（如果指定）：
│  │  │  │  ├─ 对每个 focus_area：
│  │  │  │  │  └─ 生成针对性的详细建议
│  │  │  │  └─ 返回最多 5 条建议
│  │  │  │
│  │  │  ├─ 下一步学习计划：
│  │  │  │  ├─ 推荐下个学习周期的目标：
│  │  │  │  │  ├─ 目标分数：基于当前分数 + 10-15 分
│  │  │  │  │  ├─ 推荐文本：select from (困难文本 or 新难度文本)
│  │  │  │  │  ├─ 建议练习频率：daily or 3x/week
│  │  │  │  │  └─ 预期用时：N 天
│  │  │  │  └─ 长期目标：reach score >= 90
│  │  │  │
│  │  │  └─ 异常处理：建议生成失败 → 使用通用建议
│  │  │
│  │  └─ 保存到中间变量：recommendations
│  │
│  ├─ 步骤 A8：生成可视化数据
│  │  ├─ 更新报告状态：progress = 80%, current_stage = "generating_charts"
│  │  ├─ 构建可视化对象：
│  │  │  ├─ 分数趋势图：
│  │  │  │  ├─ x_axis = date（日期）
│  │  │  │  ├─ y_axis = overall_score（分数）
│  │  │  │  ├─ 数据点 = 每条评测记录
│  │  │  │  └─ 趋势线 = 计算最小二乘法拟合
│  │  │  │
│  │  │  ├─ 各项能力对比图（雷达图）：
│  │  │  │  ├─ 维度：pronunciation、fluency、integrity、engagement
│  │  │  │  ├─ 当前值：各项的平均分或评级
│  │  │  │  └─ 对比值：上周期值或目标值
│  │  │  │
│  │  │  ├─ 学习频率热力图：
│  │  │  │  ├─ x_axis = day of week（周几）
│  │  │  │  ├─ y_axis = hour of day（几点）
│  │  │  │  ├─ 颜色深度 = 学习活跃度
│  │  │  │  └─ 找出最活跃的时间段
│  │  │  │
│  │  │  ├─ 音素掌握情况（气泡图或柱状图）：
│  │  │  │  ├─ 困难音素 Top 10
│  │  │  │  ├─ 掌握音素 Top 10
│  │  │  │  └─ 每个音素的 score 和 practice_count
│  │  │  │
│  │  │  └─ 异常处理：生成失败 → 跳过可视化，继续
│  │  │
│  │  └─ 保存到中间变量：charts_data
│  │
│  ├─ 步骤 A9：组装完整报告
│  │  ├─ 更新报告状态：progress = 90%
│  │  ├─ 构建最终报告对象：
│  │  │  ├─ 基础信息：
│  │  │  │  ├─ report_id
│  │  │  │  ├─ user_id
│  │  │  │  ├─ report_type
│  │  │  │  ├─ start_date
│  │  │  │  ├─ end_date
│  │  │  │  ├─ generated_at = now
│  │  │  │  └─ pdf_url = null（稍后可选生成）
│  │  │  │
│  │  │  ├─ 汇总统计：
│  │  │  │  ├─ total_eval_count
│  │  │  │  ├─ total_chat_count
│  │  │  │  ├─ learning_hours
│  │  │  │  ├─ avg_score
│  │  │  │  └─ overall_improvement
│  │  │  │
│  │  │  ├─ 详细分析：
│  │  │  │  ├─ eval_analysis
│  │  │  │  ├─ chat_analysis
│  │  │  │  ├─ progress_analysis
│  │  │  │  ├─ improvement_analysis
│  │  │  │  └─ charts_data
│  │  │  │
│  │  │  ├─ 建议部分（如果有）：
│  │  │  │  ├─ recommendations
│  │  │  │  └─ action_items（具体行动清单）
│  │  │  │
│  │  │  └─ 元数据：
│  │  │     ├─ data_version = "1.0"
│  │  │     ├─ report_language = user.language
│  │  │     └─ computation_time_ms = (now - task_start_time)
│  │  │
│  │  └─ 最终报告 = 上述对象
│  │
│  ├─ 步骤 A10：保存报告到数据库
│  │  ├─ 更新报告状态：progress = 95%
│  │  ├─ 序列化报告（JSON）
│  │  ├─ 调用 Database.InsertReport(report)
│  │  │  ├─ 存储字段：
│  │  │  │  ├─ report_id
│  │  │  │  ├─ user_id
│  │  │  │  ├─ report_type
│  │  │  │  ├─ start_date
│  │  │  │  ├─ end_date
│  │  │  │  ├─ report_content（JSON 序列化）
│  │  │  │  ├─ created_at
│  │  │  │  ├─ status = "success"
│  │  │  │  └─ file_size_bytes = size(report_content)
│  │  │  └─ 异常处理：数据库写入失败 → 重试 3 次，最终失败但标记为已生成
│  │  │
│  │  └─ report_content = JSON 字符串
│  │
│  ├─ 步骤 A11：缓存报告数据
│  │  ├─ 调用 Cache.SetReport(report_id, report_content)
│  │  │  ├─ 存储位置：Redis (TTL = 7 天)
│  │  │  └─ 异常处理：缓存写入失败 → 记录日志，继续
│  │  └─ 调用 Cache.SetReportMetadata(user_id, report_id)
│  │     └─ 用于快速查询用户的所有报告
│  │
│  ├─ 步骤 A12：更新用户统计
│  │  ├─ 调用 Database.UpdateUserReportStats(user_id)
│  │  │  ├─ 增加 total_reports_generated 1
│  │  │  ├─ 记录 last_report_generated_at = now
│  │  │  └─ 异常处理：更新失败 → 记录日志
│  │  └─ 可选：触发用户成就/徽章系统
│  │     └─ 如果 total_reports_generated == 5 → 解锁徽章
│  │
│  ├─ 步骤 A13：更新报告最终状态
│  │  ├─ 更新 Redis 中的报告状态：
│  │  │  ├─ status = "success"
│  │  │  ├─ progress = 100%
│  │  │  ├─ updated_at = now
│  │  │  ├─ completion_time_ms = (now - start_time)
│  │  │  └─ TTL 设置为 7 天
│  │  ├─ 同时更新数据库
│  │  └─ 异常处理：更新失败 → 记录日志
│  │
│  ├─ 步骤 A14：可选：生成 PDF 报告（异步）
│  │  ├─ 如果报告文件较大（>5MB）
│  │  │  └─ 推送 PDF 生成任务到队列（低优先级）
│  │  └─ 否则跳过
│  │
│  ├─ 步骤 A15：清理资源
│  │  ├─ 释放 Worker 线程
│  │  └─ 清理临时缓存
│  │
│  └─ 异步任务完成
│
└─ 流程结束
```

---

### 1.2 异常处理总结

| 异常点 | 阶段 | 处理方式 | 用户感知 |
|--------|------|---------|---------|
| 参数为空 | 同步 | 返回 400 | 参数错误提示 |
| Token 无效 | 同步 | 返回 401 | 需要重新登录 |
| 日期格式错误 | 同步 | 返回 400 | 参数错误 |
| 日期范围超限 | 同步 | 返回 400 | 参数错误 |
| 数据量不足 | 同步 | 返回 200 + message | 友好提示 |
| 速率限制 | 同步 | 返回 429 | 请求过于频繁 |
| Redis 连接失败 | 同步 | 返回 503 | 系统繁忙 |
| 队列满 | 同步 | 返回 503 | 系统繁忙 |
| 评测数据查询失败 | 异步 | status = "failed" | 轮询显示失败 |
| 计算失败 | 异步 | 使用默认值 | 报告仍可生成 |
| 数据库写入失败 | 异步 | 重试 3 次 | 可能延迟显示 |

---

### 1.3 第三方 API 调用总结

| API | 提供商 | 阶段 | 备注 |
|-----|--------|------|------|
| 阿里云 OSS | 阿里云 | 可选 | PDF 生成时使用 |

---

## 二、接口：GET /api/v1/report/{report_id}/status

**功能**：查询报告生成的实时状态

**流程类型**：同步查询

---

### 2.1 伪代码流程

```
流程：GET /api/v1/report/{report_id}/status
├─ 【同步阶段】
│  │
│  ├─ 步骤 1：接收 HTTP 请求
│  │  ├─ 路径参数：report_id（字符串）
│  │  └─ 异常点：report_id 为空 → 返回 400 Bad Request
│  │
│  ├─ 步骤 2：身份验证
│  │  ├─ 从 HTTP Header 获取 Authorization Token
│  │  ├─ 调用 TokenService.ValidateToken(token)
│  │  └─ 异常点：Token 无效或过期 → 返回 401 Unauthorized
│  │
│  ├─ 步骤 3：提取用户 ID
│  │  ├─ user_id = Token.解析并获取(user_id)
│  │  └─ 异常点：Token 中缺少 user_id → 返回 401
│  │
│  ├─ 步骤 4：路径参数校验
│  │  ├─ 检查 report_id 格式（应该是 report_xxxxxxx）
│  │  └─ 异常点：格式不合法 → 返回 400
│  │
│  ├─ 步骤 5：从 Redis 缓存查询报告状态
│  │  ├─ cache_key = "report:status:" + report_id
│  │  ├─ 调用 Cache.Get(cache_key)
│  │  ├─ 返回：报告状态对象
│  │  └─ 异常点：
│  │     ├─ Redis 连接失败 → 降级到数据库查询
│  │     └─ 报告不存在于缓存 → 继续步骤 6
│  │
│  ├─ 步骤 6：权限检查
│  │  ├─ 如果报告不存在于缓存：
│  │  │  ├─ 调用 Database.GetReportByID(report_id)
│  │  │  ├─ 检查 report.user_id == 当前登录用户的 user_id
│  │  │  └─ 异常点：
│  │  │     ├─ 报告不存在 → 返回 404 Not Found
│  │  │     └─ user_id 不匹配 → 返回 403 Forbidden
│  │  └─ 如果存在于缓存：
│  │     └─ 权限已在缓存中验证
│  │
│  ├─ 步骤 7：根据报告状态返回不同的响应
│  │  │
│  │  ├─ 【情况 A】：status == "generating"（报告生成中）
│  │  │  ├─ 返回响应体：
│  │  │  │  ├─ code = 200
│  │  │  │  ├─ message = "generating"
│  │  │  │  └─ data = {
│  │  │  │      report_id,
│  │  │  │      status: "generating",
│  │  │  │      progress: (0~100 之间的整数),
│  │  │  │      current_stage: (当前阶段描述),
│  │  │  │      estimated_seconds: (预估剩余时间),
│  │  │  │      message: "正在分析学习数据..."
│  │  │  │    }
│  │  │  └─ HTTP 状态码：200 OK
│  │  │
│  │  ├─ 【情况 B】：status == "success"（报告生成完成）
│  │  │  ├─ 返回响应体：
│  │  │  │  ├─ code = 200
│  │  │  │  ├─ message = "success"
│  │  │  │  └─ data = {
│  │  │  │      report_id,
│  │  │  │      status: "success",
│  │  │  │      progress: 100,
│  │  │  │      completion_time_ms,
│  │  │  │      report_type,
│  │  │  │      start_date,
│  │  │  │      end_date,
│  │  │  │      generated_at,
│  │  │  │      data_summary: {
│  │  │  │        total_eval_count,
│  │  │  │        total_chat_count,
│  │  │  │        avg_score,
│  │  │  │        learning_hours
│  │  │  │      }
│  │  │  │    }
│  │  │  └─ HTTP 状态码：200 OK
│  │  │
│  │  ├─ 【情况 C】：status == "failed"（报告生成失败）
│  │  │  ├─ 获取错误信息：
│  │  │  │  ├─ error_message
│  │  │  │  └─ error_stage（失败的阶段）
│  │  │  ├─ 返回响应体：
│  │  │  │  ├─ code = 200
│  │  │  │  ├─ message = "failed"
│  │  │  │  └─ data = {
│  │  │  │      report_id,
│  │  │  │      status: "failed",
│  │  │  │      error_message,
│  │  │  │      error_stage,
│  │  │  │      message: "报告生成失败，请重新生成"
│  │  │  │    }
│  │  │  └─ HTTP 状态码：200 OK
│  │  │
│  │  └─ 【其他情况】：未知的状态
│  │     ├─ 记录错误日志
│  │     └─ 返回 500 Internal Server Error
│  │
│  ├─ 步骤 8：可选缓存刷新
│  │  ├─ 如果状态为 "success"，重新缓存可能已过期的信息
│  │  └─ 异常处理：刷新失败 → 记录，继续
│  │
│  └─ 步骤 9：返回响应
│     └─ 返回 JSON 响应给客户端
│
└─ 流程结束
```

---

### 2.2 异常处理总结

| 异常点 | 处理方式 | 用户感知 |
|--------|---------|---------|
| report_id 为空 | 返回 400 | 参数错误 |
| Token 过期 | 返回 401 | 需要重新登录 |
| report_id 格式错误 | 返回 400 | 参数错误 |
| Redis 连接失败 | 降级到数据库 | 查询可能变慢 |
| 报告不存在 | 返回 404 | 报告不存在 |
| 权限不匹配 | 返回 403 | 无权限访问 |

---

## 三、接口：GET /api/v1/report/{report_id}

**功能**：获取报告的完整内容

**流程类型**：同步查询

---

### 3.1 伪代码流程

```
流程：GET /api/v1/report/{report_id}
├─ 【同步阶段】
│  │
│  ├─ 步骤 1：接收 HTTP 请求
│  │  ├─ 路径参数：report_id（字符串）
│  │  ├─ 查询参数：
│  │  │  ├─ format（字符串，可选）：["json", "pdf"]，默认 "json"
│  │  │  └─ include_charts（布尔值，可选，默认 true）
│  │  └─ 异常点：report_id 为空 → 返回 400 Bad Request
│  │
│  ├─ 步骤 2：身份验证
│  │  ├─ 从 HTTP Header 获取 Authorization Token
│  │  ├─ 调用 TokenService.ValidateToken(token)
│  │  └─ 异常点：Token 无效或过期 → 返回 401 Unauthorized
│  │
│  ├─ 步骤 3：提取用户 ID
│  │  ├─ user_id = Token.解析并获取(user_id)
│  │  └─ 异常点：Token 中缺少 user_id → 返回 401
│  │
│  ├─ 步骤 4：路径参数校验
│  │  ├─ 检查 report_id 格式
│  │  ├─ 检查 format 是否为有效值
│  │  └─ 异常点：格式不合法 → 返回 400
│  │
│  ├─ 步骤 5：从 Redis 缓存查询完整报告
│  │  ├─ cache_key = "report:content:" + report_id
│  │  ├─ 调用 Cache.Get(cache_key)
│  │  ├─ 如果命中：
│  │  │  ├─ report_content = 缓存数据
│  │  │  └─ 跳转到步骤 8（权限检查）
│  │  └─ 异常点：Redis 连接失败 → 降级到数据库查询
│  │
│  ├─ 步骤 6：从数据库查询完整报告
│  │  ├─ 调用 Database.GetReportByID(report_id)
│  │  ├─ 返回：report_record（包含完整报告内容）
│  │  └─ 异常点：
│  │     ├─ 查询失败 → 返回 500
│  │     ├─ 报告不存在 → 返回 404
│  │     └─ 报告状态不是 "success" → 返回 202 + status
│  │
│  ├─ 步骤 7：权限检查
│  │  ├─ 检查 report_record.user_id == 当前登录用户的 user_id
│  │  └─ 异常点：user_id 不匹配 → 返回 403 Forbidden
│  │
│  ├─ 步骤 8：反序列化报告内容
│  │  ├─ report_data = JSON.parse(report_content)
│  │  └─ 异常处理：JSON 解析失败 → 返回 500
│  │
│  ├─ 步骤 9：根据参数处理数据
│  │  ├─ 如果 format == "pdf"：
│  │  │  ├─ 步骤 9.1：检查 PDF 是否已生成
│  │  │  │  ├─ 如果 report_data.pdf_url 不为空：
│  │  │  │  │  ├─ 验证 PDF 文件是否仍存在
│  │  │  │  │  │  ├─ 调用 OSS.HeadObject(pdf_url)
│  │  │  │  │  │  └─ 异常处理：对象不存在 → 设置为需要重新生成
│  │  │  │  │  ├─ 如果存在 → 返回 PDF URL（302 重定向）
│  │  │  │  │  └─ 如果不存在 → 继续步骤 9.2
│  │  │  │  └─ 如果为空 → 继续步骤 9.2
│  │  │  │
│  │  │  ├─ 步骤 9.2：异步生成 PDF（如果不存在）
│  │  │  │  ├─ 推送 PDF 生成任务到队列
│  │  │  │  ├─ 返回 202 Accepted + 预估时间
│  │  │  │  └─ 异常处理：队列满 → 返回 503
│  │  │  │
│  │  │  └─ 流程结束（异步处理 PDF）
│  │  │
│  │  └─ 如果 format == "json"：
│  │     ├─ 步骤 9.3：处理 JSON 响应
│  │     ├─ 如果 include_charts == false：
│  │     │  └─ 删除 report_data.charts_data 字段
│  │     └─ 继续步骤 10
│  │
│  ├─ 步骤 10：构建最终响应体
│  │  ├─ 响应结构：
│  │  │  ├─ code = 200
│  │  │  ├─ message = "success"
│  │  │  └─ data = {
│  │  │      report_id,
│  │  │      report_type,
│  │  │      start_date,
│  │  │      end_date,
│  │  │      generated_at,
│  │  │      status: "success",
│  │  │      
│  │  │      汇总统计（summary）: {
│  │  │        total_eval_count,
│  │  │        total_chat_count,
│  │  │        total_session_count,
│  │  │        learning_hours,
│  │  │        average_score,
│  │  │        best_score,
│  │  │        worst_score,
│  │  │        overall_improvement,
│  │  │        engagement_score
│  │  │      },
│  │  │      
│  │  │      发音评测分析（eval_analysis）: {
│  │  │        scores: {
│  │  │          avg_overall,
│  │  │          avg_pronunciation,
│  │  │          avg_fluency,
│  │  │          avg_integrity
│  │  │        },
│  │  │        distribution: {
│  │  │          excellent_count,
│  │  │          good_count,
│  │  │          fair_count,
│  │  │          needs_improvement_count
│  │  │        },
│  │  │        trend: "上升/下降/平稳",
│  │  │        difficult_phonemes: [ ... ],
│  │  │        mastered_phonemes: [ ... ],
│  │  │        most_improved_phonemes: [ ... ],
│  │  │        most_challenging_texts: [ ... ],
│  │  │        easiest_texts: [ ... ]
│  │  │      },
│  │  │      
│  │  │      对话学习分析（chat_analysis）: {
│  │  │        frequency: {
│  │  │          daily_avg,
│  │  │          most_active_date,
│  │  │          least_active_date
│  │  │        },
│  │  │        consistency_score,
│  │  │        topics: [ ... ],
│  │  │        average_feedback_rating,
│  │  │        engagement_pattern
│  │  │      },
│  │  │      
│  │  │      学习进度（progress_analysis）: {
│  │  │        learning_level: "Beginner/Intermediate/Advanced/Expert",
│  │  │        ability_levels: {
│  │  │          pronunciation_level,
│  │  │          fluency_level,
│  │  │          integrity_level
│  │  │        },
│  │  │        text_mastery_count,
│  │  │        text_in_progress_count,
│  │  │        overall_progress_pct,
│  │  │        expected_mastery_date,
│  │  │        comparison_with_previous: {
│  │  │          improvement_pct,
│  │  │          trend,
│  │  │          ranking_info（可选）
│  │  │        }
│  │  │      },
│  │  │      
│  │  │      改善情况（improvement_analysis）: {
│  │  │        most_improved_aspects: [ ... ],
│  │  │        newly_mastered_phonemes: [ ... ],
│  │  │        still_challenging_phonemes: [ ... ]
│  │  │      },
│  │  │      
│  │  │      建议部分（recommendations（可选））: {
│  │  │        phoneme_recommendations: [ ... ],
│  │  │        method_recommendations: [ ... ],
│  │  │        next_learning_plan: {
│  │  │          target_score,
│  │  │          recommended_texts,
│  │  │          suggested_frequency,
│  │  │          estimated_days
│  │  │        }
│  │  │      },
│  │  │      
│  │  │      可视化数据（charts（可选））: {
│  │  │        score_trend: { ... },
│  │  │        ability_radar: { ... },
│  │  │        study_heatmap: { ... },
│  │  │        phoneme_distribution: { ... }
│  │  │      }
│  │  │    }
│  │  └─ HTTP 状态码：200 OK
│  │
│  ├─ 步骤 11：记录访问统计（可选）
│  │  ├─ 调用 Analytics.RecordAccess("report_view", user_id, report_id)
│  │  └─ 异常处理：记录失败 → 继续（非关键）
│  │
│  ├─ 步骤 12：缓存优化
│  │  ├─ 如果报告内容较大，可能已在步骤 5 中被缓存
│  │  └─ 异常处理：缓存失败 → 记录日志
│  │
│  └─ 步骤 13：返回响应
│     └─ 返回 JSON 响应给客户端
│
└─ 流程结束
```

---

### 3.2 异常处理总结

| 异常点 | 处理方式 | 用户感知 |
|--------|---------|---------|
| report_id 为空 | 返回 400 | 参数错误 |
| Token 过期 | 返回 401 | 需要重新登录 |
| report_id 格式错误 | 返回 400 | 参数错误 |
| 报告不存在 | 返回 404 | 报告不存在 |
| 权限不匹配 | 返回 403 | 无权限访问 |
| 报告未完成 | 返回 202 | 显示生成状态 |
| JSON 解析失败 | 返回 500 | 系统错误 |
| PDF 不存在 | 异步生成 | 返回 202 |

---

## 四、接口：GET /api/v1/report/list

**功能**：获取用户的报告列表

**流程类型**：同步查询

---

### 4.1 伪代码流程

```
流程：GET /api/v1/report/list
├─ 【同步阶段】
│  │
│  ├─ 步骤 1：接收 HTTP 请求
│  │  ├─ 查询参数：
│  │  │  ├─ page（整数，默认 1）
│  │  │  ├─ page_size（整数，默认 20，最大 100）
│  │  ├─ report_type（字符串，可选）：["weekly", "monthly", "custom"]
│  │  ├─ status（字符串，可选）：["generating", "success", "failed"]
│  │  ├─ order_by（字符串，默认 "created_at"）
│  │  └─ order（字符串："asc" 或 "desc"，默认 "desc"）
│  │  └─ 异常点：page 或 page_size 非法 → 返回 400
│  │
│  ├─ 步骤 2：身份验证
│  │  ├─ 从 HTTP Header 获取 Authorization Token
│  │  ├─ 调用 TokenService.ValidateToken(token)
│  │  └─ 异常点：Token 无效或过期 → 返回 401 Unauthorized
│  │
│  ├─ 步骤 3：提取用户 ID
│  │  ├─ user_id = Token.解析并获取(user_id)
│  │  └─ 异常点：Token 中缺少 user_id → 返回 401
│  │
│  ├─ 步骤 4：参数标准化和校验
│  │  ├─ 如果 page < 1 → 设置为 1
│  │  ├─ 如果 page_size > 100 → 设置为 100
│  │  ├─ 如果 page_size < 1 → 设置为 1
│  │  ├─ order = 转换为小写(order)
│  │  ├─ 如果 order 不是 ["asc", "desc"] → 设置为 "desc"
│  │  ├─ order_by = 转换为小写(order_by)
│  │  ├─ 如果 order_by 不是 ["created_at", "score"] → 设置为 "created_at"
│  │  ├─ offset = (page - 1) * page_size
│  │  ├─ 如果 report_type 不为空：
│  │  │  └─ 验证是否为有效值
│  │  └─ 如果 status 不为空：
│  │     └─ 验证是否为有效值
│  │
│  ├─ 步骤 5：构建查询条件
│  │  ├─ 初始化 filter = {}
│  │  ├─ filter.user_id = user_id
│  │  ├─ 如果 report_type 不为空：
│  │  │  └─ filter.report_type = report_type
│  │  └─ 如果 status 不为空：
│  │     └─ filter.status = status
│  │
│  ├─ 步骤 6：尝试从缓存获取（常见查询）
│  │  ├─ 如果 page == 1 且无其他过滤 且 order_by == "created_at" 且 order == "desc"：
│  │  │  ├─ cache_key = "report:list:" + user_id + ":page1"
│  │  │  ├─ 调用 Cache.Get(cache_key)
│  │  │  └─ 如果命中 → 跳转到步骤 10（构建响应）
│  │  └─ 否则 → 继续步骤 7
│  │
│  ├─ 步骤 7：查询报告记录总数
│  │  ├─ 调用 Database.CountReports(filter)
│  │  ├─ 返回：total（总记录数）
│  │  └─ 异常点：数据库查询失败 → 返回 500
│  │
│  ├─ 步骤 8：计算分页信息
│  │  ├─ total_pages = ceil(total / page_size)
│  │  ├─ 检查 page 是否超出范围
│  │  │  └─ 异常点：page > total_pages 且 total > 0 → 返回 400
│  │  ├─ 如果 total == 0：
│  │  │  └─ 返回空列表，total_pages = 0
│  │  └─ 继续查询数据
│  │
│  ├─ 步骤 9：从数据库查询报告列表
│  │  ├─ 调用 Database.GetReports(filter, offset, page_size, order_by, order)
│  │  ├─ 返回：reports 列表，每条包含：
│  │  │  ├─ report_id
│  │  │  ├─ report_type
│  │  │  ├─ start_date
│  │  │  ├─ end_date
│  │  │  ├─ created_at
│  │  │  ├─ status
│  │  │  ├─ summary: {
│  │  │  │  ├─ total_eval_count
│  │  │  │  ├─ total_chat_count
│  │  │  │  ├─ avg_score
│  │  │  │  └─ learning_hours
│  │  │  │}
│  │  │  └─ file_size_bytes
│  │  └─ 异常点：数据库查询失败 → 返回 500
│  │
│  ├─ 步骤 10：丰富化报告列表数据
│  │  ├─ 对每条报告：
│  │  │  ├─ 如果 status == "generating"：
│  │  │  │  ├─ 从 Redis 查询最新的 progress 和 current_stage
│  │  │  │  └─ 更新对应字段
│  │  │  └─ 添加 readable_size_mb = file_size_bytes / 1024 / 1024
│  │  └─ 异常处理：查询失败 → 使用默认值
│  │
│  ├─ 步骤 11：构建响应体
│  │  ├─ 响应结构：
│  │  │  ├─ code = 200
│  │  │  ├─ message = "success"
│  │  │  └─ data = {
│  │  │      items: [
│  │  │        {
│  │  │          report_id,
│  │  │          report_type,
│  │  │          start_date,
│  │  │          end_date,
│  │  │          created_at,
│  │  │          status,
│  │  │          summary: {
│  │  │            total_eval_count,
│  │  │            total_chat_count,
│  │  │            avg_score,
│  │  │            learning_hours
│  │  │          },
│  │  │          progress（如果 status == "generating"）,
│  │  │          file_size_mb
│  │  │        },
│  │  │        ...
│  │  │      ],
│  │  │      pagination: {
│  │  │        page,
│  │  │        page_size,
│  │  │        total,
│  │  │        total_pages
│  │  │      }
│  │  │    }
│  │  └─ HTTP 状态码：200 OK
│  │
│  ├─ 步骤 12：缓存优化
│  │  ├─ 如果是常见查询（page == 1，无过滤）
│  │  │  ├─ 调用 Cache.Set(cache_key, 响应数据, TTL=30分钟)
│  │  │  └─ 异常处理：缓存设置失败 → 记录日志
│  │  └─ 否则 → 跳过缓存
│  │
│  └─ 步骤 13：返回响应
│     └─ 返回 JSON 响应给客户端
│
└─ 流程结束
```

---

### 4.2 异常处理总结

| 异常点 | 处理方式 | 用户感知 |
|--------|---------|---------|
| 分页参数非法 | 返回 400 | 参数错误 |
| Token 过期 | 返回 401 | 需要重新登录 |
| 页码超出范围 | 返回 400 | 参数错误 |
| 数据库查询失败 | 返回 500 | 系统错误 |

---

## 五、接口：DELETE /api/v1/report/{report_id}

**功能**：删除指定的报告

**流程类型**：同步删除操作

---

### 5.1 伪代码流程

```
流程：DELETE /api/v1/report/{report_id}
├─ 【同步阶段】
│  │
│  ├─ 步骤 1：接收 HTTP 请求
│  │  ├─ 路径参数：report_id（字符串）
│  │  └─ 异常点：report_id 为空 → 返回 400 Bad Request
│  │
│  ├─ 步骤 2：身份验证
│  │  ├─ 从 HTTP Header 获取 Authorization Token
│  │  ├─ 调用 TokenService.ValidateToken(token)
│  │  └─ 异常点：Token 无效或过期 → 返回 401 Unauthorized
│  │
│  ├─ 步骤 3：提取用户 ID
│  │  ├─ user_id = Token.解析并获取(user_id)
│  │  └─ 异常点：Token 中缺少 user_id → 返回 401
│  │
│  ├─ 步骤 4：路径参数校验
│  │  ├─ 检查 report_id 格式（应该是 report_xxxxxxx）
│  │  └─ 异常点：格式不合法 → 返回 400
│  │
│  ├─ 步骤 5：权限检查和可删除性检查
│  │  ├─ 调用 Database.GetReportByID(report_id)
│  │  ├─ 异常点：
│  │  │  ├─ 报告不存在 → 返回 404 Not Found
│  │  │  ├─ report.user_id != 当前用户 ID → 返回 403 Forbidden
│  │  │  └─ 查询失败 → 返回 500
│  │  └─ report_record = 查询结果
│  │
│  ├─ 步骤 6：获取相关信息用于后续清理
│  │  ├─ pdf_url = report_record.pdf_url
│  │  ├─ report_type = report_record.report_type
│  │  └─ file_size_bytes = report_record.file_size_bytes
│  │
│  ├─ 步骤 7：开始事务（确保数据一致性）
│  │  ├─ 调用 Database.BeginTransaction()
│  │  └─ 异常点：事务启动失败 → 返回 500
│  │
│  ├─ 步骤 8：删除数据库中的报告记录
│  │  ├─ 调用 Database.DeleteReport(report_id)
│  │  └─ 异常点：
│  │     ├─ 删除失败 → 回滚事务，返回 500
│  │     └─ 没有影响的行（已被删除）→ 回滚事务，返回 404
│  │
│  ├─ 步骤 9：提交事务
│  │  ├─ 调用 Database.CommitTransaction()
│  │  └─ 异常点：提交失败 → 回滚，返回 500
│  │
│  ├─ 步骤 10：删除 OSS 中的 PDF 文件（如果存在，异步 + 最终一致性）
│  │  ├─ 如果 pdf_url 不为空：
│  │  │  ├─ 推送删除任务到队列
│  │  │  ├─ 调用 Queue.PushOSSDeleteTask([pdf_url])
│  │  │  └─ 异常处理：队列满 → 记录日志，继续
│  │  └─ 否则跳过
│  │
│  ├─ 步骤 11：清除 Redis 缓存
│  │  ├─ 需要清除的缓存键：
│  │  │  ├─ report:status:{report_id}
│  │  │  ├─ report:content:{report_id}
│  │  │  ├─ report:list:{user_id}:* （所有分页的列表缓存）
│  │  │  └─ 调用 Cache.DeleteKeys(所有相关键)
│  │  └─ 异常处理：缓存删除失败 → 记录日志，继续
│  │
│  ├─ 步骤 12：更新用户统计信息
│  │  ├─ 调用 Database.UpdateUserReportStats(user_id)
│  │  │  ├─ 减少 total_reports_count 1
│  │  │  └─ 重新计算 last_report_generated_at（如果删除的是最新报告）
│  │  └─ 异常处理：更新失败 → 记录日志，继续
│  │
│  ├─ 步骤 13：记录审计日志
│  │  ├─ 调用 AuditLog.Record({
│  │  │  user_id,
│  │  │  action: "delete_report",
│  │  │  report_id,
│  │  │  report_type,
│  │  │  file_size_bytes,
│  │  │  timestamp: now
│  │  │})
│  │  └─ 异常处理：记录失败 → 继续（非关键）
│  │
│  ├─ 步骤 14：构建响应体
│  │  ├─ 响应结构：
│  │  │  ├─ code = 200
│  │  │  ├─ message = "success"
│  │  │  └─ data = {
│  │  │      report_id,
│  │  │      message: "报告已删除"
│  │  │    }
│  │  └─ HTTP 状态码：200 OK
│  │
│  └─ 步骤 15：返回响应
│     └─ 返回 JSON 响应给客户端
│
├─ 【异步阶段】（后台进行，不阻塞返回）
│  │
│  └─ OSS 文件删除
│     ├─ Worker 从队列拉取删除任务
│     ├─ 对每个 pdf_url：
│     │  ├─ 调用 OSS.DeleteObject(pdf_url)
│     │  │  ├─ 第三方 API 调用点：阿里云 OSS
│     │  │  └─ 异常处理：删除失败 → 重试 3 次
│     │  └─ 异常处理：URL 失效 → 跳过
│     └─ 清理完毕
│
└─ 流程结束
```

---

### 5.2 事务处理说明

```
事务流程：
├─ BeginTransaction()
├─ 【事务内操作】
│  └─ DeleteReport(report_id)
│     └─ [如果操作失败] → RollbackTransaction()
├─ CommitTransaction()
└─ [事务外操作（异步）]
   ├─ 删除 OSS 文件
   ├─ 清除 Redis 缓存
   └─ 更新统计信息
```

---

### 5.3 异常处理总结

| 异常点 | 处理方式 | 用户感知 |
|--------|---------|---------|
| report_id 为空 | 返回 400 | 参数错误 |
| Token 过期 | 返回 401 | 需要重新登录 |
| report_id 格式错误 | 返回 400 | 参数错误 |
| 报告不存在 | 返回 404 | 报告不存在 |
| 权限不匹配 | 返回 403 | 无权限访问 |
| 事务启动失败 | 返回 500 | 系统错误 |
| 数据库删除失败 | 回滚事务，返回 500 | 系统错误 |
| 事务提交失败 | 返回 500 | 系统错误 |
| OSS 删除失败 | 重试 3 次，记录日志 | 用户无感知 |
| 缓存删除失败 | 记录日志，继续 | 用户无感知 |

---

## 六、接口：GET /api/v1/report/dashboard

**功能**：获取用户的学习仪表板，展示最新统计和概览

**流程类型**：同步查询（可能涉及多个子查询）

---

### 6.1 伪代码流程

```
流程：GET /api/v1/report/dashboard
├─ 【同步阶段】
│  │
│  ├─ 步骤 1：接收 HTTP 请求
│  │  ├─ 查询参数：
│  │  │  ├─ time_range（字符串，可选）：["today", "week", "month", "all"]，默认 "month"
│  │  │  └─ include_forecast（布尔值，可选，默认 true）
│  │  └─ 异常点：time_range 为非法值 → 返回 400
│  │
│  ├─ 步骤 2：身份验证
│  │  ├─ 从 HTTP Header 获取 Authorization Token
│  │  ├─ 调用 TokenService.ValidateToken(token)
│  │  └─ 异常点：Token 无效或过期 → 返回 401 Unauthorized
│  │
│  ├─ 步骤 3：提取用户 ID
│  │  ├─ user_id = Token.解析并获取(user_id)
│  │  └─ 异常点：Token 中缺少 user_id → 返回 401
│  │
│  ├─ 步骤 4：参数标准化
│  │  ├─ time_range = 转换为小写(time_range)
│  │  ├─ 如果 time_range 不在 ["today", "week", "month", "all"] → 设置为 "month"
│  │  ├─ 计算时间范围：
│  │  │  ├─ 如果 time_range == "today"：
│  │  │  │  ├─ start_date = 今天
│  │  │  │  └─ end_date = 今天
│  │  │  ├─ 如果 time_range == "week"：
│  │  │  │  ├─ start_date = 本周一
│  │  │  │  └─ end_date = 本周日（或今天，取较早者）
│  │  │  ├─ 如果 time_range == "month"：
│  │  │  │  ├─ start_date = 本月第一天
│  │  │  │  └─ end_date = 本月最后一天（或今天，取较早者）
│  │  │  └─ 如果 time_range == "all"：
│  │  │     ├─ start_date = 用户首次活动日期
│  │  │     └─ end_date = 今天
│  │  └─ 异常处理：日期计算失败 → 使用默认值
│  │
│  ├─ 步骤 5：尝试从缓存获取仪表板数据
│  │  ├─ cache_key = "dashboard:" + user_id + ":" + time_range
│  │  ├─ cache_ttl = 5 分钟（仪表板需要较高的实时性）
│  │  ├─ 调用 Cache.Get(cache_key)
│  │  ├─ 如果命中且未过期：
│  │  │  ├─ dashboard_data = 缓存数据
│  │  │  └─ 跳转到步骤 18（构建响应）
│  │  └─ 异常点：Redis 连接失败 → 降级到数据库查询
│  │
│  ├─ 步骤 6：获取用户基本信息
│  │  ├─ 调用 Database.GetUserProfile(user_id)
│  │  ├─ 返回：
│  │  │  ├─ username
│  │  │  ├─ learning_level
│  │  │  ├─ registration_date
│  │  │  ├─ total_learning_days
│  │  │  └─ last_activity_at
│  │  └─ 异常点：查询失败 → 返回 500
│  │
│  ├─ 步骤 7：获取时间范围内的汇总统计
│  │  ├─ 调用 Database.GetDashboardSummary(user_id, start_date, end_date)
│  │  ├─ 返回：
│  │  │  ├─ total_eval_count
│  │  │  ├─ total_chat_count
│  │  │  ├─ total_session_count
│  │  │  ├─ learning_hours
│  │  │  ├─ avg_eval_score
│  │  │  ├─ avg_chat_duration_ms
│  │  │  └─ texts_studied
│  │  └─ 异常点：查询失败 → 设置为默认值，继续
│  │
│  ├─ 步骤 8：获取最近的报告
│  │  ├─ 调用 Database.GetLatestReport(user_id, status="success")
│  │  ├─ 返回：
│  │  │  ├─ report_id
│  │  │  ├─ report_type
│  │  │  ├─ start_date
│  │  │  ├─ end_date
│  │  │  ├─ generated_at
│  │  │  └─ summary（汇总数据）
│  │  └─ 异常处理：没有报告 → 设置为 null
│  │
│  ├─ 步骤 9：获取最近 7 天的学习趋势
│  │  ├─ 调用 Database.GetDailyActivityStats(user_id, last_7_days)
│  │  ├─ 返回：
│  │  │  ├─ date: daily_eval_count、daily_chat_count、daily_hours
│  │  │  └─ 返回数组（每天一条）
│  │  └─ 异常处理：查询失败 → 设置为空数组
│  │
│  ├─ 步骤 10：获取排名信息（可选，基于同级别用户）
│  │  ├─ 如果用户的 learning_level 已确定：
│  │  │  ├─ 调用 Database.GetUserRanking(user_id, learning_level)
│  │  │  ├─ 返回：
│  │  │  │  ├─ user_rank（排名）
│  │  │  │  ├─ total_in_level（同级别用户总数）
│  │  │  │  └─ percentile（百分位数）
│  │  │  └─ 异常处理：查询失败 → 设置为 null
│  │  └─ 否则跳过
│  │
│  ├─ 步骤 11：获取困难音素Top 5（基于最近评测）
│  │  ├─ 调用 Database.GetTopDifficultPhonemes(user_id, last_7_days, limit=5)
│  │  ├─ 返回：
│  │  │  ├─ phoneme
│  │  │  ├─ avg_score
│  │  │  ├─ practice_count
│  │  │  └─ latest_attempt_date
│  │  └─ 异常处理：查询失败 → 设置为空数组
│  │
│  ├─ 步骤 12：获取最活跃的文本 Top 5
│  │  ├─ 调用 Database.GetTopTexts(user_id, start_date, end_date, limit=5)
│  │  ├─ 返回：
│  │  │  ├─ text_id
│  │  │  ├─ content
│  │  │  ├─ practice_count
│  │  │  ├─ avg_score
│  │  │  └─ learning_status
│  │  └─ 异常处理：查询失败 → 设置为空数组
│  │
│  ├─ 步骤 13：获取个性化建议
│  │  ├─ 调用 RecommendationService.GenerateDashboardTips(user_id, user_stats)
│  │  ├─ 返回：
│  │  │  ├─ tips：[]（最多 5 条）
│  │  │  ├─ each tip 包含：
│  │  │  │  ├─ type：["achievement", "encouragement", "suggestion", "warning"]
│  │  │  │  ├─ message
│  │  │  │  └─ action_url（可选）
│  │  │  └─ 生成建议的逻辑（示例）：
│  │  │     ├─ 如果今天没有学习 → 鼓励建议
│  │  │     ├─ 如果本周平均分有进步 → 成就建议
│  │  │     ├─ 如果有困难音素 → 学习建议
│  │  │     └─ 如果连续 3 天没学习 → 警告建议
│  │  └─ 异常处理：建议生成失败 → 设置为空数组
│  │
│  ├─ 步骤 14：计算预测数据（如果 include_forecast == true）
│  │  ├─ 基于历史数据预测：
│  │  │  ├─ 预测的学习速度
│  │  │  │  ├─ 计算最近 30 天的平均分数增长
│  │  │  │  ├─ 预测达到目标分数（90+）所需时间
│  │  │  │  └─ 格式：X 天
│  │  │  │
│  │  │  ├─ 预测的下周活跃度
│  │  │  │  ├─ 计算最近 4 周的平均学习频率
│  │  │  │  ├─ 预测下周的预期学习天数
│  │  │  │  └─ 格式：X 天
│  │  │  │
│  │  │  └─ 预测的进度里程碑
│  │  │     ├─ 下一个预期的掌握里程碑
│  │  │     ├─ 估计日期
│  │  │     └─ 需要的努力程度
│  │  └─ 异常处理：预测计算失败 → 设置为 null
│  │
│  ├─ 步骤 15：构建学习卡片（快速概览）
│  │  ├─ 连续学习天数：
│  │  │  ├─ 计算用户最近连续有学习活动的天数
│  │  │  └─ 格式：X 天
│  │  ├─ 本周学习时长：
│  │  │  ├─ 累计本周的学习时长
│  │  │  └─ 格式：X 小时 Y 分钟
│  │  ├─ 本月完成评测数：
│  │  │  ├─ 计算本月已完成的评测数量
│  │  │  └─ 显示对目标的进度条
│  │  └─ 未完成任务数：
│  │     ├─ 查询用户的待完成学习计划或作业
│  │     └─ 如果有的话显示数量
│  │
│  ├─ 步骤 16：构建快捷操作（推荐后续行动）
│  │  ├─ 根据用户的学习状态推荐行动：
│  │  │  ├─ 如果有困难音素 → 推荐相关练习链接
│  │  │  ├─ 如果本周学习少 → 推荐开始新评测
│  │  │  ├─ 如果最近生成了报告 → 推荐查看报告链接
│  │  │  └─ 推荐开始对话练习
│  │  └─ 返回最多 4 个快捷操作
│  │
│  ├─ 步骤 17：构建完整仪表板对象
│  │  ├─ 基础信息：
│  │  │  ├─ username
│  │  │  ├─ user_level: learning_level
│  │  │  ├─ registration_date
│  │  │  ├─ total_learning_days
│  │  │  └─ last_activity_at
│  │  │
│  │  ├─ 快速统计（summary）：
│  │  │  ├─ time_range
│  │  │  ├─ start_date
│  │  │  ├─ end_date
│  │  │  ├─ total_eval_count
│  │  │  ├─ total_chat_count
│  │  │  ├─ learning_hours
│  │  │  ├─ avg_eval_score
│  │  │  └─ texts_studied
│  │  │
│  │  ├─ 最近报告：
│  │  │  ├─ report（如果有）或 null
│  │  │
│  │  ├─ 学习卡片（cards）：
│  │  │  ├─ 连续学习天数
│  │  │  ├─ 本周学习时长
│  │  │  ├─ 本月评测数
│  │  │  └─ 未完成任务
│  │  │
│  │  ├─ 趋势数据（trend）：
│  │  │  ├─ daily_stats（最近 7 天）
│  │  │  ├─ score_trend
│  │  │  └─ activity_trend
│  │  │
│  │  ├─ 排名信息（如果有）：
│  │  │  ├─ user_rank
│  │  │  ├─ total_in_level
│  │  │  └─ percentile
│  │  │
│  │  ├─ 学习焦点（focus）：
│  │  │  ├─ difficult_phonemes（困难音素 Top 5）
│  │  │  └─ top_texts（最活跃文本 Top 5）
│  │  │
│  │  ├─ 个性化建议（tips）：
│  │  │  └─ tips[]
│  │  │
│  │  ├─ 快捷操作（actions）：
│  │  │  └─ actions[]
│  │  │
│  │  └─ 预测数据（forecast（可选））：
│  │     ├─ days_to_mastery
│  │     ├─ expected_activity_next_week
│  │     └─ next_milestone
│  │
│  ├─ 步骤 18：缓存仪表板数据
│  │  ├─ 调用 Cache.Set(cache_key, dashboard_data, TTL=5分钟)
│  │  └─ 异常处理：缓存设置失败 → 记录日志，继续
│  │
│  ├─ 步骤 19：构建最终响应体
│  │  ├─ 响应结构：
│  │  │  ├─ code = 200
│  │  │  ├─ message = "success"
│  │  │  └─ data = dashboard_data
│  │  └─ HTTP 状态码：200 OK
│  │
│  ├─ 步骤 20：记录访问统计（可选）
│  │  ├─ 调用 Analytics.RecordAccess("dashboard_view", user_id)
│  │  └─ 异常处理：记录失败 → 继续（非关键）
│  │
│  └─ 步骤 21：返回响应
│     └─ 返回 JSON 响应给客户端
│
└─ 流程结束
```

---

### 6.2 异常处理总结

| 异常点 | 处理方式 | 用户感知 |
|--------|---------|---------|
| time_range 非法值 | 返回 400 | 参数错误 |
| Token 过期 | 返回 401 | 需要重新登录 |
| 日期计算失败 | 使用默认值 | 继续显示 |
| Redis 连接失败 | 降级到数据库 | 查询可能变慢 |
| 用户基本信息查询失败 | 返回 500 | 系统错误 |
| 汇总统计查询失败 | 使用默认值 | 某些数据缺失 |
| 报告查询失败 | 设置为 null | 不显示最近报告 |
| 排名计算失败 | 设置为 null | 不显示排名信息 |
| 建议生成失败 | 设置为空数组 | 不显示个性化建议 |
| 预测计算失败 | 设置为 null | 不显示预测数据 |

---

## 七、综合总结表

### 7.1 接口特性对比

| 接口 | 同步/异步 | 操作类型 | 关键步骤数 | 异常点数 | 第三方 API |
|------|---------|---------|----------|--------|-----------|
| POST /report/generate | 同步+异步 | 创建报告 | 13 + 15 | 15 | 0 个 |
| GET /report/{id}/status | 同步 | 查询状态 | 9 | 6 | 0 个 |
| GET /report/{id} | 同步 | 查询内容 | 13 | 8 | 1 个（OSS） |
| GET /report/list | 同步 | 查询列表 | 13 | 7 | 0 个 |
| DELETE /report/{id} | 同步+异步 | 删除报告 | 15 | 10 | 1 个（OSS） |
| GET /report/dashboard | 同步 | 查询概览 | 21 | 10 | 0 个 |

---

### 7.2 数据存储涉及的系统

| 接口 | MySQL | Redis | OSS | 队列 |
|------|--------|-------|-----|------|
| POST /report/generate | ✓ | ✓ | - | ✓ |
| GET /report/{id}/status | ✓ | ✓ | - | - |
| GET /report/{id} | ✓ | ✓ | ✓ | ✓（可选 PDF） |
| GET /report/list | ✓ | ✓ | - | - |
| DELETE /report/{id} | ✓ | ✓ | ✓ | ✓ |
| GET /report/dashboard | ✓ | ✓ | - | - |

---

### 7.3 缓存策略总结

| 缓存键 | TTL | 更新时机 | 清除时机 |
|--------|-----|---------|---------|
| report:status:{report_id} | 2 小时 | 报告生成时 | 报告删除时 |
| report:content:{report_id} | 7 天 | 报告完成时 | 报告删除时 |
| report:list:{user_id}:page1 | 30 分钟 | 新报告生成时 | 报告删除或新增时 |
| dashboard:{user_id}:{time_range} | 5 分钟 | 实时查询 | 自动过期 |

---

## 八、关键设计决策说明

### 8.1 为什么 POST /report/generate 采用异步处理？

**原因**：
1. **数据量大**：需要汇总大量评测、对话、文本等数据
2. **计算复杂**：需要进行多维度分析、统计、趋势计算
3. **避免超时**：整个流程可能需要 10-30 秒以上
4. **支持重试**：异步任务失败可自动重试
5. **提升用户体验**：立即返回任务 ID，不需要等待

### 8.2 为什么 GET /report/dashboard 使用较短的缓存 TTL？

**原因**：
1. **数据实时性**：用户希望看到最新的学习数据
2. **平衡性能**：5 分钟 TTL 能够处理突发流量
3. **不过期数据**：5 分钟内的数据变化不大
4. **灵活更新**：新报告生成或新活动时可主动刷新缓存

### 8.3 为什么报告生成要分多个阶段？

**原因**：
1. **进度反馈**：用户可以看到实时进度
2. **问题隔离**：知道哪个阶段失败
3. **资源优化**：可以在不同阶段应用不同的策略
4. **灵活调整**：可以跳过或重新处理某些阶段

### 8.4 为什么删除报告需要使用事务？

**原因**：
1. **一致性**：确保报告记录完全删除
2. **原子性**：从用户角度，删除要么完全成功，要么完全失败
3. **防止脏数据**：避免报告被部分删除的情况

### 8.5 为什么仪表板要包含这么多数据源？

**原因**：
1. **全面性**：展示用户学习的完整状态
2. **个性化**：提供针对性的建议
3. **激励作用**：通过排名、成就、预测等激励用户
4. **决策支持**：帮助用户制定下一步学习计划

---

## 九、报告生成的数据结构完整示例

```
报告对象结构：
{
  "report_id": "report_20240115_abc123def456",
  "user_id": "user_12345",
  "report_type": "monthly",  // weekly / monthly / custom
  "start_date": "2024-01-01",
  "end_date": "2024-01-31",
  "status": "success",
  "created_at": "2024-01-31T18:00:00Z",
  "generated_at": "2024-01-31T18:15:32Z",
  "computation_time_ms": 924,
  
  "summary": {
    "total_eval_count": 45,
    "total_chat_count": 120,
    "total_session_count": 15,
    "learning_hours": 12.5,
    "average_score": 78.3,
    "best_score": 95,
    "worst_score": 62,
    "overall_improvement": "+5.2%",
    "engagement_score": 82
  },

  "eval_analysis": {
    "scores": {
      "avg_overall": 78.3,
      "avg_pronunciation": 76.5,
      "avg_fluency": 79.2,
      "avg_integrity": 78.0
    },
    "distribution": {
      "excellent_count": 8,    // >= 90
      "good_count": 18,        // 80-89
      "fair_count": 15,        // 70-79
      "needs_improvement_count": 4  // < 70
    },
    "trend": "上升",
    "difficult_phonemes": [
      {"phoneme": "zh", "avg_score": 65.2, "practice_count": 12},
      ...
    ],
    "mastered_phonemes": [
      {"phoneme": "a", "avg_score": 92.3, "practice_count": 18},
      ...
    ],
    "most_improved_phonemes": [
      {"phoneme": "r", "improvement": "+18.5%", "before": 62, "after": 80.5},
      ...
    ],
    "most_challenging_texts": [
      {"text_id": "text_123", "content": "...", "avg_score": 68},
      ...
    ],
    "easiest_texts": [
      {"text_id": "text_456", "content": "...", "avg_score": 92},
      ...
    ]
  },

  "chat_analysis": {
    "frequency": {
      "daily_avg": 3.87,
      "most_active_date": "2024-01-15",
      "least_active_date": "2024-01-08"
    },
    "consistency_score": 75,
    "topics": [
      {"topic": "daily_conversation", "count": 45},
      ...
    ],
    "average_feedback_rating": 4.2,
    "engagement_pattern": "一致性好，周末学习较少"
  },

  "progress_analysis": {
    "learning_level": "Intermediate",
    "ability_levels": {
      "pronunciation_level": "Advanced",
      "fluency_level": "Intermediate",
      "integrity_level": "Intermediate"
    },
    "text_mastery_count": 12,
    "text_in_progress_count": 8,
    "overall_progress_pct": 60.0,
    "expected_mastery_date": "2024-04-15",
    "comparison_with_previous": {
      "improvement_pct": "+5.2%",
      "trend": "上升",
      "ranking_info": {
        "user_rank": 128,
        "total_in_level": 1250,
        "percentile": 89.8
      }
    }
  },

  "improvement_analysis": {
    "most_improved_aspects": [
      {"aspect": "流利度", "improvement": "+3.2%", "from": 76.0, "to": 79.2}
    ],
    "newly_mastered_phonemes": ["zh", "ch", "sh"],
    "still_challenging_phonemes": ["r", "l", "er"]
  },

  "recommendations": {
    "phoneme_recommendations": [
      {
        "phoneme": "r",
        "difficulty": "high",
        "message": "'r' 发音困难，建议反复练习这些文本：...",
        "recommended_texts": ["text_123", "text_456"],
        "suggested_practice_times": 20
      }
    ],
    "method_recommendations": [
      {
        "category": "study_frequency",
        "message": "保持当前学习热情，建议日均至少 30 分钟"
      }
    ],
    "next_learning_plan": {
      "target_score": 88,
      "recommended_texts": ["text_789", "text_101112"],
      "suggested_frequency": "每天",
      "estimated_days": 21
    }
  },

  "charts": {
    "score_trend": {
      "type": "line",
      "x_axis": ["2024-01-01", "2024-01-02", ...],
      "y_axis": [72, 75, 78, ...],
      "trend_line": {...}
    },
    "ability_radar": {
      "dimensions": ["发音", "流利度", "完整度", "参与度"],
      "current_values": [76.5, 79.2, 78.0, 82],
      "target_values": [85, 85, 85, 85]
    },
    "study_heatmap": {
      "days": ["一", "二", "三", ...],
      "hours": [0, 1, 2, ...],
      "intensity": [[0, 1, 2], [1, 3, 2], ...]
    },
    "phoneme_distribution": {
      "difficult": [...],
      "mastered": [...]
    }
  }
}
```

---

## 十、伪代码规范说明

本伪代码遵循以下规范：

1. **缩进**：表示层级关系和逻辑块
2. **异常点**：标记为 `异常点：条件 → 处理`
3. **API 调用**：标记为 `第三方 API 调用点：服务名`
4. **同步 vs 异步**：在流程开始明确标注
5. **变量赋值**：使用 `变量名 = 函数()` 格式
6. **条件分支**：使用 `【情况 A】`、`【情况 B】` 等标注
7. **事务**：使用 `BeginTransaction()` 等标注
8. **HTTP 状态码**：标注每个返回分支的状态码
9. **缓存策略**：明确标注 TTL 和更新时机

---

**AI 学习报告模块核心流程伪代码已完成！** 🎉

现在已完成以下模块的详细伪代码：
- ✅ Chat 模块（5 个接口）
- ✅ Evaluate 模块（6 个接口）
- ✅ Report 模块（6 个接口）

**总计：17 个接口的完整核心流程伪代码**