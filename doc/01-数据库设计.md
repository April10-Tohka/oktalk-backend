# OKTalk 系统数据库设计（MySQL）

## 第一部分：表清单

| 表名 | 用途说明 | 数据量估计 |
|------|---------|---------|
| users | 用户基础信息表 | 10K - 100K |
| user_profiles | 用户扩展信息表 | 10K - 100K |
| voice_conversations | 语音对话记录表 | 100K - 1M |
| conversation_messages | 对话消息明细表 | 1M - 10M |
| pronunciation_evaluations | 发音评测记录表 | 100K - 500K |
| evaluation_details | 评测详细数据表（音素级） | 100K - 500K |
| feedback_records | 反馈记录表 | 100K - 500K |
| learning_reports | 学习报告表 | 10K - 100K |
| report_statistics | 报告统计明细表 | 10K - 100K |
| system_settings | 系统配置表（非业务） | < 100 |

---

## 第二部分：表结构设计

### 表 1：users（用户基础信息表）

**用途**：存储用户的基础账户信息

| 字段名 | 数据类型 | 长度 | 非空 | 唯一 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | VARCHAR | 36 | ✓ | ✓ | - | 用户 ID (UUID) |
| username | VARCHAR | 100 | ✓ | ✓ | - | 用户名 |
| email | VARCHAR | 255 | ✓ | ✓ | - | 邮箱 |
| password_hash | VARCHAR | 255 | ✓ | ✗ | - | 密码哈希值 |
| phone | VARCHAR | 20 | ✗ | ✗ | NULL | 手机号 |
| avatar_url | VARCHAR | 500 | ✗ | ✗ | NULL | 头像 URL |
| grade | INT | - | ✗ | ✗ | NULL | 年级 (1-6 代表小学 1-6 年级) |
| status | ENUM | - | ✓ | ✗ | 'active' | 账户状态：active/suspended/deleted |
| language | VARCHAR | 10 | ✓ | ✗ | 'en' | 语言偏好：en/zh |
| created_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | - | ✗ | ✗ | NULL | 软删除时间 |

**索引**：
- PRIMARY KEY: id
- UNIQUE KEY: username, email
- INDEX: created_at, deleted_at

---

### 表 2：user_profiles（用户扩展信息表）

**用途**：存储用户的详细个人信息和学习进度

| 字段名 | 数据类型 | 长度 | 非空 | 唯一 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | VARCHAR | 36 | ✓ | ✓ | - | 主键 ID (UUID) |
| user_id | VARCHAR | 36 | ✓ | ✓ | - | 用户 ID (FK) |
| full_name | VARCHAR | 100 | ✗ | ✗ | NULL | 真实姓名 |
| age | INT | - | ✗ | ✗ | NULL | 年龄 |
| gender | ENUM | - | ✗ | ✗ | NULL | 性别：male/female/other |
| bio | TEXT | - | ✗ | ✗ | NULL | 个人简介 |
| total_conversations | INT | - | ✓ | ✗ | 0 | 总对话数 |
| total_evaluations | INT | - | ✓ | ✗ | 0 | 总评测数 |
| total_reports | INT | - | ✓ | ✗ | 0 | 总报告数 |
| average_evaluation_score | FLOAT | - | ✓ | ✗ | 0.0 | 平均评测分数 |
| last_conversation_at | TIMESTAMP | - | ✗ | ✗ | NULL | 上次对话时间 |
| last_evaluation_at | TIMESTAMP | - | ✗ | ✗ | NULL | 上次评测时间 |
| created_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- PRIMARY KEY: id
- FOREIGN KEY: user_id → users(id)
- UNIQUE KEY: user_id
- INDEX: last_conversation_at, last_evaluation_at

---

### 表 3：voice_conversations（语音对话记录表）

**用途**：存储用户的 AI 语音对话会话

| 字段名 | 数据类型 | 长度 | 非空 | 唯一 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | VARCHAR | 36 | ✓ | ✓ | - | 对话 ID (UUID) |
| user_id | VARCHAR | 36 | ✓ | ✗ | - | 用户 ID (FK) |
| topic | VARCHAR | 200 | ✓ | ✗ | - | 对话主题（如 "Hello"、"Daily Routine"） |
| difficulty_level | ENUM | - | ✓ | ✗ | 'beginner' | 难度等级：beginner/intermediate/advanced |
| conversation_type | ENUM | - | ✓ | ✗ | 'free_talk' | 对话类型：free_talk/scenario/question_answer |
| message_count | INT | - | ✓ | ✗ | 0 | 消息总数（包括用户和 AI） |
| duration_seconds | INT | - | ✓ | ✗ | 0 | 对话时长（秒） |
| status | ENUM | - | ✓ | ✗ | 'active' | 状态：active/completed/paused |
| language_pair | VARCHAR | 20 | ✓ | ✗ | 'en-zh' | 语言对：en-zh/en-es 等 |
| summary | TEXT | - | ✗ | ✗ | NULL | 对话摘要 |
| ai_model | VARCHAR | 100 | ✓ | ✗ | 'gpt-4' | AI 模型名称 |
| score | INT | - | ✗ | ✗ | NULL | 对话评分（0-100） |
| feedback | TEXT | - | ✗ | ✗ | NULL | AI 反馈内容 |
| created_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | - | ✗ | ✗ | NULL | 软删除时间 |

**索引**：
- PRIMARY KEY: id
- FOREIGN KEY: user_id → users(id)
- INDEX: user_id, created_at, status
- INDEX: difficulty_level, conversation_type

---

### 表 4：conversation_messages（对话消息明细表）

**用途**：存储对话中的每一条消息（用户或 AI）

| 字段名 | 数据类型 | 长度 | 非空 | 唯一 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | VARCHAR | 36 | ✓ | ✓ | - | 消息 ID (UUID) |
| conversation_id | VARCHAR | 36 | ✓ | ✗ | - | 对话 ID (FK) |
| sender_type | ENUM | - | ✓ | ✗ | - | 发送者类型：user/ai |
| sender_id | VARCHAR | 36 | ✗ | ✗ | NULL | 发送者 ID（仅当 sender_type=user 时有值） |
| message_text | LONGTEXT | - | ✓ | ✗ | - | 消息文本内容 |
| message_audio_url | VARCHAR | 500 | ✗ | ✗ | NULL | 消息音频 URL（用户语音消息） |
| message_audio_duration | INT | - | ✗ | ✗ | NULL | 音频时长（秒） |
| ai_response_text | LONGTEXT | - | ✗ | ✗ | NULL | AI 回复文本（仅当 sender_type=ai 时有值） |
| ai_response_audio_url | VARCHAR | 500 | ✗ | ✗ | NULL | AI 回复音频 URL |
| pronunciation_score | INT | - | ✗ | ✗ | NULL | 发音评分（仅对用户消息有值，0-100） |
| pronunciation_feedback | TEXT | - | ✗ | ✗ | NULL | 发音反馈 |
| sequence_number | INT | - | ✓ | ✗ | - | 消息序号（对话内的顺序） |
| created_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- PRIMARY KEY: id
- FOREIGN KEY: conversation_id → voice_conversations(id)
- INDEX: conversation_id, sequence_number
- INDEX: sender_type, created_at

---

### 表 5：pronunciation_evaluations（发音评测记录表）

**用途**：存储用户的发音评测结果（核心数据）

| 字段名 | 数据类型 | 长度 | 非空 | 唯一 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | VARCHAR | 36 | ✓ | ✓ | - | 评测 ID (UUID) |
| user_id | VARCHAR | 36 | ✓ | ✗ | - | 用户 ID (FK) |
| target_text | VARCHAR | 500 | ✓ | ✗ | - | 目标朗读文本 |
| recognized_text | VARCHAR | 500 | ✗ | ✗ | NULL | 识别出的文本 |
| audio_url | VARCHAR | 500 | ✗ | ✗ | NULL | 原始录音 URL |
| audio_duration | INT | - | ✗ | ✗ | NULL | 录音时长（秒） |
| overall_score | INT | - | ✓ | ✗ | 0 | 综合评分（0-100） |
| accuracy_score | INT | - | ✓ | ✗ | 0 | 准确度评分（0-100） |
| fluency_score | INT | - | ✓ | ✗ | 0 | 流利度评分（0-100） |
| integrity_score | INT | - | ✓ | ✗ | 0 | 完整度评分（0-100） |
| feedback_level | ENUM | - | ✓ | ✗ | 'C' | 反馈级别：S/A/B/C |
| feedback_text | TEXT | - | ✗ | ✗ | NULL | 反馈文本 |
| feedback_audio_url | VARCHAR | 500 | ✗ | ✗ | NULL | 反馈音频 URL |
| demo_audio_type | ENUM | - | ✗ | ✗ | NULL | 示范音频类型：word/sentence/NULL |
| demo_audio_content | VARCHAR | 500 | ✗ | ✗ | NULL | 示范内容（如 "apples" 或完整句子） |
| demo_audio_url | VARCHAR | 500 | ✗ | ✗ | NULL | 示范音频 URL |
| difficulty_level | ENUM | - | ✓ | ✗ | 'beginner' | 难度级别：beginner/intermediate/advanced |
| speech_assessment_json | LONGTEXT | - | ✗ | ✗ | NULL | 讯飞返回的原始评测数据（JSON） |
| status | ENUM | - | ✓ | ✗ | 'completed' | 状态：pending/processing/completed/failed |
| error_message | VARCHAR | 500 | ✗ | ✗ | NULL | 错误信息（失败时） |
| created_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- PRIMARY KEY: id
- FOREIGN KEY: user_id → users(id)
- INDEX: user_id, created_at
- INDEX: feedback_level, overall_score
- INDEX: status, created_at

---

### 表 6：evaluation_details（评测详细数据表）

**用途**：存储评测的音素级别详细数据（用于诊断和分析）

| 字段名 | 数据类型 | 长度 | 非空 | 唯一 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | VARCHAR | 36 | ✓ | ✓ | - | 主键 ID (UUID) |
| evaluation_id | VARCHAR | 36 | ✓ | ✗ | - | 评测 ID (FK) |
| word_index | INT | - | ✓ | ✗ | - | 单词序号（0 开始） |
| word_text | VARCHAR | 100 | ✓ | ✗ | - | 单词文本 |
| word_score | INT | - | ✓ | ✗ | 0 | 单词评分（0-100） |
| is_problem_word | BOOLEAN | - | ✓ | ✗ | false | 是否为问题单词（score < 70） |
| phoneme_details | JSON | - | ✗ | ✗ | NULL | 音素详情（JSON 数组）：[{phoneme: "æ", score: 60}, ...] |
| begin_time_ms | INT | - | ✗ | ✗ | NULL | 单词开始时间（毫秒） |
| end_time_ms | INT | - | ✗ | ✗ | NULL | 单词结束时间（毫秒） |
| created_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 创建时间 |

**索引**：
- PRIMARY KEY: id
- FOREIGN KEY: evaluation_id → pronunciation_evaluations(id)
- INDEX: evaluation_id, word_index
- INDEX: is_problem_word

---

### 表 7：feedback_records（反馈记录表）

**用途**：存储系统生成的反馈记录（用于反馈质量追踪）

| 字段名 | 数据类型 | 长度 | 非空 | 唯一 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | VARCHAR | 36 | ✓ | ✓ | - | 反馈 ID (UUID) |
| evaluation_id | VARCHAR | 36 | ✓ | ✓ | - | 关联的评测 ID (FK) |
| feedback_level | ENUM | - | ✓ | ✗ | - | 反馈级别：S/A/B/C |
| feedback_text | TEXT | - | ✓ | ✗ | - | 反馈文本 |
| feedback_audio_url | VARCHAR | 500 | ✗ | ✗ | NULL | 反馈音频 URL |
| demo_type | ENUM | - | ✗ | ✗ | NULL | 示范类型：word/sentence/NULL |
| demo_content | VARCHAR | 500 | ✗ | ✗ | NULL | 示范内容 |
| demo_audio_url | VARCHAR | 500 | ✗ | ✗ | NULL | 示范音频 URL |
| generation_method | VARCHAR | 50 | ✓ | ✗ | 'llm' | 生成方法：llm/template/manual |
| ai_model | VARCHAR | 100 | ✗ | ✗ | NULL | 使用的 AI 模型（如 qwen-max） |
| generation_duration_ms | INT | - | ✗ | ✗ | NULL | 生成耗时（毫秒） |
| status | ENUM | - | ✓ | ✗ | 'completed' | 状态：generating/completed/failed |
| quality_score | INT | - | ✗ | ✗ | NULL | 反馈质量评分（0-100，用于内部评估） |
| user_feedback | VARCHAR | 500 | ✗ | ✗ | NULL | 用户对反馈的评价 |
| created_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- PRIMARY KEY: id
- FOREIGN KEY: evaluation_id → pronunciation_evaluations(id)
- UNIQUE KEY: evaluation_id
- INDEX: feedback_level, status, created_at

---

### 表 8：learning_reports（学习报告表）

**用途**：存储用户的学习报告（周报/月报）

| 字段名 | 数据类型 | 长度 | 非空 | 唯一 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | VARCHAR | 36 | ✓ | ✓ | - | 报告 ID (UUID) |
| user_id | VARCHAR | 36 | ✓ | ✗ | - | 用户 ID (FK) |
| report_type | ENUM | - | ✓ | ✗ | 'weekly' | 报告类型：weekly/monthly/custom |
| period_start_date | DATE | - | ✓ | ✗ | - | 统计周期起始日期 |
| period_end_date | DATE | - | ✓ | ✗ | - | 统计周期结束日期 |
| total_conversations | INT | - | ✓ | ✗ | 0 | 总对话数 |
| total_evaluations | INT | - | ✓ | ✗ | 0 | 总评测数 |
| total_study_minutes | INT | - | ✓ | ✗ | 0 | 总学习时长（分钟） |
| average_conversation_score | FLOAT | - | ✓ | ✗ | 0.0 | 平均对话评分 |
| average_evaluation_score | FLOAT | - | ✓ | ✗ | 0.0 | 平均评测分数 |
| s_level_count | INT | - | ✓ | ✗ | 0 | S 级评测数 |
| a_level_count | INT | - | ✓ | ✗ | 0 | A 级评测数 |
| b_level_count | INT | - | ✓ | ✗ | 0 | B 级评测数 |
| c_level_count | INT | - | ✓ | ✗ | 0 | C 级评测数 |
| improvement_rate | FLOAT | - | ✓ | ✗ | 0.0 | 进步率（与上期对比，%） |
| strengths | JSON | - | ✗ | ✗ | NULL | 优势总结（JSON 数组） |
| weaknesses | JSON | - | ✗ | ✗ | NULL | 不足总结（JSON 数组） |
| recommendations | LONGTEXT | - | ✗ | ✗ | NULL | 改进建议 |
| report_content | LONGTEXT | - | ✗ | ✗ | NULL | 完整报告内容（HTML/Markdown） |
| generated_by | VARCHAR | 50 | ✓ | ✗ | 'system' | 生成者：system/manual |
| created_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- PRIMARY KEY: id
- FOREIGN KEY: user_id → users(id)
- INDEX: user_id, created_at
- INDEX: report_type, period_start_date
- INDEX: user_id, period_end_date

---

### 表 9：report_statistics（报告统计明细表）

**用途**：存储报告中的具体统计数据（便于细粒度分析）

| 字段名 | 数据类型 | 长度 | 非空 | 唯一 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | VARCHAR | 36 | ✓ | ✓ | - | 主键 ID (UUID) |
| report_id | VARCHAR | 36 | ✓ | ✗ | - | 报告 ID (FK) |
| stat_date | DATE | - | ✓ | ✗ | - | 统计日期 |
| daily_conversations | INT | - | ✓ | ✗ | 0 | 当日对话数 |
| daily_evaluations | INT | - | ✓ | ✗ | 0 | 当日评测数 |
| daily_study_minutes | INT | - | ✓ | ✗ | 0 | 当日学习时长（分钟） |
| daily_avg_evaluation_score | FLOAT | - | ✓ | ✗ | 0.0 | 当日平均评测分数 |
| daily_s_level_count | INT | - | ✓ | ✗ | 0 | 当日 S 级数 |
| daily_a_level_count | INT | - | ✓ | ✗ | 0 | 当日 A 级数 |
| daily_b_level_count | INT | - | ✓ | ✗ | 0 | 当日 B 级数 |
| daily_c_level_count | INT | - | ✓ | ✗ | 0 | 当日 C 级数 |
| topic_breakdown | JSON | - | ✗ | ✗ | NULL | 主题分布（JSON）：{topic: count} |
| difficulty_breakdown | JSON | - | ✗ | ✗ | NULL | 难度分布（JSON）：{level: count} |
| created_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 创建时间 |

**索引**：
- PRIMARY KEY: id
- FOREIGN KEY: report_id → learning_reports(id)
- INDEX: report_id, stat_date
- INDEX: stat_date

---

### 表 10：system_settings（系统配置表）

**用途**：存储系统级配置（评分阈值、反馈模板等）

| 字段名 | 数据类型 | 长度 | 非空 | 唯一 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | VARCHAR | 36 | ✓ | ✓ | - | 主键 ID (UUID) |
| config_key | VARCHAR | 100 | ✓ | ✓ | - | 配置键 |
| config_value | LONGTEXT | - | ✓ | ✗ | - | 配置值（支持 JSON） |
| config_type | ENUM | - | ✓ | ✗ | 'string' | 配置类型：string/int/float/json/boolean |
| description | VARCHAR | 500 | ✗ | ✗ | NULL | 配置描述 |
| is_editable | BOOLEAN | - | ✓ | ✗ | true | 是否可编辑 |
| created_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | ✓ | ✗ | CURRENT_TIMESTAMP | 更新时间 |

**示例配置**：
- `feedback_s_level_min_score`: 90
- `feedback_a_level_min_score`: 70
- `feedback_b_level_min_score`: 50
- `forbidden_words`: ["bad", "wrong", "terrible", ...]
- `report_generation_schedule`: "0 0 * * 1" (每周一生成报告)

**索引**：
- PRIMARY KEY: id
- UNIQUE KEY: config_key

---

## 第三部分：Go Struct 模型

### models/user.go

```go
package models

import "time"

// User 用户基础信息表对应的结构体
type User struct {
	ID            string    `gorm:"primaryKey;type:varchar(36)" json:"id"`
	Username      string    `gorm:"uniqueIndex;type:varchar(100);not null" json:"username"`
	Email         string    `gorm:"uniqueIndex;type:varchar(255);not null" json:"email"`
	PasswordHash  string    `gorm:"type:varchar(255);not null" json:"-"` // 不序列化密码
	Phone         *string   `gorm:"type:varchar(20)" json:"phone"`
	AvatarURL     *string   `gorm:"type:varchar(500)" json:"avatar_url"`
	Grade         *int      `gorm:"type:int" json:"grade"` // 1-6 代表小学年级
	Status        string    `gorm:"type:enum('active','suspended','deleted');default:'active';not null" json:"status"`
	Language      string    `gorm:"type:varchar(10);default:'en';not null" json:"language"`
	CreatedAt     time.Time `gorm:"autoCreateTime;type:timestamp" json:"created_at"`
	UpdatedAt     time.Time `gorm:"autoUpdateTime;type:timestamp" json:"updated_at"`
	DeletedAt     *time.Time `gorm:"type:timestamp" json:"deleted_at"`

	// 关联
	Profile              *UserProfile              `json:"profile,omitempty"`
	VoiceConversations   []*VoiceConversation      `json:"conversations,omitempty"`
	PronunciationEvals   []*PronunciationEvaluation `json:"evaluations,omitempty"`
	LearningReports      []*LearningReport         `json:"reports,omitempty"`
}

// TableName 指定表名
func (User) TableName() string {
	return "users"
}

// UserProfile 用户扩展信息表对应的结构体
type UserProfile struct {
	ID                        string     `gorm:"primaryKey;type:varchar(36)" json:"id"`
	UserID                    string     `gorm:"uniqueIndex;type:varchar(36);not null" json:"user_id"`
	FullName                  *string    `gorm:"type:varchar(100)" json:"full_name"`
	Age                       *int       `gorm:"type:int" json:"age"`
	Gender                    *string    `gorm:"type:enum('male','female','other')" json:"gender"`
	Bio                       *string    `gorm:"type:text" json:"bio"`
	TotalConversations        int        `gorm:"type:int;default:0;not null" json:"total_conversations"`
	TotalEvaluations          int        `gorm:"type:int;default:0;not null" json:"total_evaluations"`
	TotalReports              int        `gorm:"type:int;default:0;not null" json:"total_reports"`
	AverageEvaluationScore    float64    `gorm:"type:float;default:0.0;not null" json:"average_evaluation_score"`
	LastConversationAt        *time.Time `gorm:"type:timestamp" json:"last_conversation_at"`
	LastEvaluationAt          *time.Time `gorm:"type:timestamp" json:"last_evaluation_at"`
	CreatedAt                 time.Time  `gorm:"autoCreateTime;type:timestamp" json:"created_at"`
	UpdatedAt                 time.Time  `gorm:"autoUpdateTime;type:timestamp" json:"updated_at"`

	// 关联
	User *User `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
}

// TableName 指定表名
func (UserProfile) TableName() string {
	return "user_profiles"
}
```

---

### models/voice_conversation.go

```go
package models

import "time"

// VoiceConversation 语音对话记录表对应的结构体
type VoiceConversation struct {
	ID                 string                    `gorm:"primaryKey;type:varchar(36)" json:"id"`
	UserID             string                    `gorm:"index;type:varchar(36);not null" json:"user_id"`
	Topic              string                    `gorm:"type:varchar(200);not null" json:"topic"`
	DifficultyLevel    string                    `gorm:"index;type:enum('beginner','intermediate','advanced');default:'beginner';not null" json:"difficulty_level"`
	ConversationType   string                    `gorm:"index;type:enum('free_talk','scenario','question_answer');default:'free_talk';not null" json:"conversation_type"`
	MessageCount       int                       `gorm:"type:int;default:0;not null" json:"message_count"`
	DurationSeconds    int                       `gorm:"type:int;default:0;not null" json:"duration_seconds"`
	Status             string                    `gorm:"type:enum('active','completed','paused');default:'active';not null" json:"status"`
	LanguagePair       string                    `gorm:"type:varchar(20);default:'en-zh';not null" json:"language_pair"`
	Summary            *string                   `gorm:"type:text" json:"summary"`
	AIModel            string                    `gorm:"type:varchar(100);default:'gpt-4';not null" json:"ai_model"`
	Score              *int                      `gorm:"type:int" json:"score"` // 0-100
	Feedback           *string                   `gorm:"type:text" json:"feedback"`
	CreatedAt          time.Time                 `gorm:"index;autoCreateTime;type:timestamp" json:"created_at"`
	UpdatedAt          time.Time                 `gorm:"autoUpdateTime;type:timestamp" json:"updated_at"`
	DeletedAt          *time.Time                `gorm:"type:timestamp" json:"deleted_at"`

	// 关联
	User     *User                     `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
	Messages []*ConversationMessage    `json:"messages,omitempty"`
}

// TableName 指定表名
func (VoiceConversation) TableName() string {
	return "voice_conversations"
}

// ConversationMessage 对话消息明细表对应的结构体
type ConversationMessage struct {
	ID                       string    `gorm:"primaryKey;type:varchar(36)" json:"id"`
	ConversationID           string    `gorm:"index;type:varchar(36);not null" json:"conversation_id"`
	SenderType               string    `gorm:"type:enum('user','ai');not null" json:"sender_type"` // user / ai
	SenderID                 *string   `gorm:"type:varchar(36)" json:"sender_id"`                  // 仅 user 时有值
	MessageText              string    `gorm:"type:longtext;not null" json:"message_text"`
	MessageAudioURL          *string   `gorm:"type:varchar(500)" json:"message_audio_url"`
	MessageAudioDuration     *int      `gorm:"type:int" json:"message_audio_duration"` // 秒
	AIResponseText           *string   `gorm:"type:longtext" json:"ai_response_text"`
	AIResponseAudioURL       *string   `gorm:"type:varchar(500)" json:"ai_response_audio_url"`
	PronunciationScore       *int      `gorm:"type:int" json:"pronunciation_score"` // 0-100
	PronunciationFeedback    *string   `gorm:"type:text" json:"pronunciation_feedback"`
	SequenceNumber           int       `gorm:"type:int;not null" json:"sequence_number"`
	CreatedAt                time.Time `gorm:"autoCreateTime;type:timestamp" json:"created_at"`
	UpdatedAt                time.Time `gorm:"autoUpdateTime;type:timestamp" json:"updated_at"`

	// 关联
	Conversation *VoiceConversation `gorm:"foreignKey:ConversationID;references:ID" json:"conversation,omitempty"`
}

// TableName 指定表名
func (ConversationMessage) TableName() string {
	return "conversation_messages"
}
```

---

### models/pronunciation_evaluation.go

```go
package models

import (
	"database/sql/driver"
	"encoding/json"
	"time"
)

// PronunciationEvaluation 发音评测记录表对应的结构体
type PronunciationEvaluation struct {
	ID                        string                `gorm:"primaryKey;type:varchar(36)" json:"id"`
	UserID                    string                `gorm:"index;type:varchar(36);not null" json:"user_id"`
	TargetText                string                `gorm:"type:varchar(500);not null" json:"target_text"`
	RecognizedText            *string               `gorm:"type:varchar(500)" json:"recognized_text"`
	AudioURL                  *string               `gorm:"type:varchar(500)" json:"audio_url"`
	AudioDuration             *int                  `gorm:"type:int" json:"audio_duration"` // 秒
	OverallScore              int                   `gorm:"type:int;default:0;not null" json:"overall_score"`
	AccuracyScore             int                   `gorm:"type:int;default:0;not null" json:"accuracy_score"`
	FluentcyScore             int                   `gorm:"type:int;default:0;not null" json:"fluency_score"`
	IntegrityScore            int                   `gorm:"type:int;default:0;not null" json:"integrity_score"`
	FeedbackLevel             string                `gorm:"index;type:enum('S','A','B','C');default:'C';not null" json:"feedback_level"`
	FeedbackText              *string               `gorm:"type:text" json:"feedback_text"`
	FeedbackAudioURL          *string               `gorm:"type:varchar(500)" json:"feedback_audio_url"`
	DemoAudioType             *string               `gorm:"type:enum('word','sentence')" json:"demo_audio_type"` // word / sentence / NULL
	DemoAudioContent          *string               `gorm:"type:varchar(500)" json:"demo_audio_content"`
	DemoAudioURL              *string               `gorm:"type:varchar(500)" json:"demo_audio_url"`
	DifficultyLevel           string                `gorm:"type:enum('beginner','intermediate','advanced');default:'beginner';not null" json:"difficulty_level"`
	SpeechAssessmentJSON      *string               `gorm:"type:longtext" json:"speech_assessment_json"` // 讯飞原始数据
	Status                    string                `gorm:"index;type:enum('pending','processing','completed','failed');default:'completed';not null" json:"status"`
	ErrorMessage              *string               `gorm:"type:varchar(500)" json:"error_message"`
	CreatedAt                 time.Time             `gorm:"index;autoCreateTime;type:timestamp" json:"created_at"`
	UpdatedAt                 time.Time             `gorm:"autoUpdateTime;type:timestamp" json:"updated_at"`

	// 关联
	User                *User                    `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
	EvaluationDetails   []*EvaluationDetail      `json:"evaluation_details,omitempty"`
	FeedbackRecord      *FeedbackRecord          `json:"feedback_record,omitempty"`
}

// TableName 指定表名
func (PronunciationEvaluation) TableName() string {
	return "pronunciation_evaluations"
}

// EvaluationDetail 评测详细数据表对应的结构体
type EvaluationDetail struct {
	ID                string          `gorm:"primaryKey;type:varchar(36)" json:"id"`
	EvaluationID      string          `gorm:"index;type:varchar(36);not null" json:"evaluation_id"`
	WordIndex         int             `gorm:"type:int;not null" json:"word_index"`
	WordText          string          `gorm:"type:varchar(100);not null" json:"word_text"`
	WordScore         int             `gorm:"type:int;default:0;not null" json:"word_score"`
	IsProblemWord     bool            `gorm:"type:boolean;default:false;not null" json:"is_problem_word"`
	PhonemeDetails    PhonemeDetails  `gorm:"type:json" json:"phoneme_details"` // JSON 数组
	BeginTimeMS       *int            `gorm:"type:int" json:"begin_time_ms"`
	EndTimeMS         *int            `gorm:"type:int" json:"end_time_ms"`
	CreatedAt         time.Time       `gorm:"autoCreateTime;type:timestamp" json:"created_at"`

	// 关联
	Evaluation *PronunciationEvaluation `gorm:"foreignKey:EvaluationID;references:ID" json:"evaluation,omitempty"`
}

// TableName 指定表名
func (EvaluationDetail) TableName() string {
	return "evaluation_details"
}

// PhonemeDetails 音素详情（用于 JSON 序列化）
type PhonemeDetails []struct {
	Phoneme string `json:"phoneme"`
	Score   int    `json:"score"`
}

// Scan 实现 sql.Scanner 接口，用于 GORM 扫描 JSON
func (pd *PhonemeDetails) Scan(value interface{}) error {
	if value == nil {
		return nil
	}
	bytes, ok := value.([]byte)
	if !ok {
		return nil
	}
	return json.Unmarshal(bytes, &pd)
}

// Value 实现 driver.Valuer 接口，用于 GORM 写入 JSON
func (pd PhonemeDetails) Value() (driver.Value, error) {
	return json.Marshal(pd)
}
```

---

### models/feedback.go

```go
package models

import "time"

// FeedbackRecord 反馈记录表对应的结构体
type FeedbackRecord struct {
	ID                      string                   `gorm:"primaryKey;type:varchar(36)" json:"id"`
	EvaluationID            string                   `gorm:"uniqueIndex;type:varchar(36);not null" json:"evaluation_id"`
	FeedbackLevel           string                   `gorm:"type:enum('S','A','B','C');not null" json:"feedback_level"`
	FeedbackText            string                   `gorm:"type:text;not null" json:"feedback_text"`
	FeedbackAudioURL        *string                  `gorm:"type:varchar(500)" json:"feedback_audio_url"`
	DemoType                *string                  `gorm:"type:enum('word','sentence')" json:"demo_type"`
	DemoContent             *string                  `gorm:"type:varchar(500)" json:"demo_content"`
	DemoAudioURL            *string                  `gorm:"type:varchar(500)" json:"demo_audio_url"`
	GenerationMethod        string                   `gorm:"type:varchar(50);default:'llm';not null" json:"generation_method"` // llm / template / manual
	AIModel                 *string                  `gorm:"type:varchar(100)" json:"ai_model"`                                // qwen-max 等
	GenerationDurationMS    *int                     `gorm:"type:int" json:"generation_duration_ms"`
	Status                  string                   `gorm:"index;type:enum('generating','completed','failed');default:'completed';not null" json:"status"`
	QualityScore            *int                     `gorm:"type:int" json:"quality_score"` // 0-100，内部评估
	UserFeedback            *string                  `gorm:"type:varchar(500)" json:"user_feedback"`
	CreatedAt               time.Time                `gorm:"autoCreateTime;type:timestamp" json:"created_at"`
	UpdatedAt               time.Time                `gorm:"autoUpdateTime;type:timestamp" json:"updated_at"`

	// 关联
	Evaluation *PronunciationEvaluation `gorm:"foreignKey:EvaluationID;references:ID" json:"evaluation,omitempty"`
}

// TableName 指定表名
func (FeedbackRecord) TableName() string {
	return "feedback_records"
}
```

---

### models/learning_report.go

```go
package models

import (
	"database/sql/driver"
	"encoding/json"
	"time"
)

// LearningReport 学习报告表对应的结构体
type LearningReport struct {
	ID                        string                `gorm:"primaryKey;type:varchar(36)" json:"id"`
	UserID                    string                `gorm:"index;type:varchar(36);not null" json:"user_id"`
	ReportType                string                `gorm:"type:enum('weekly','monthly','custom');default:'weekly';not null" json:"report_type"`
	PeriodStartDate           time.Time             `gorm:"type:date;not null" json:"period_start_date"`
	PeriodEndDate             time.Time             `gorm:"type:date;not null" json:"period_end_date"`
	TotalConversations        int                   `gorm:"type:int;default:0;not null" json:"total_conversations"`
	TotalEvaluations          int                   `gorm:"type:int;default:0;not null" json:"total_evaluations"`
	TotalStudyMinutes         int                   `gorm:"type:int;default:0;not null" json:"total_study_minutes"`
	AverageConversationScore  float64               `gorm:"type:float;default:0.0;not null" json:"average_conversation_score"`
	AverageEvaluationScore    float64               `gorm:"type:float;default:0.0;not null" json:"average_evaluation_score"`
	SLevelCount               int                   `gorm:"type:int;default:0;not null" json:"s_level_count"`
	ALevelCount               int                   `gorm:"type:int;default:0;not null" json:"a_level_count"`
	BLevelCount               int                   `gorm:"type:int;default:0;not null" json:"b_level_count"`
	CLevelCount               int                   `gorm:"type:int;default:0;not null" json:"c_level_count"`
	ImprovementRate           float64               `gorm:"type:float;default:0.0;not null" json:"improvement_rate"` // %
	Strengths                 StringArray           `gorm:"type:json" json:"strengths"`                              // JSON 数组
	Weaknesses                StringArray           `gorm:"type:json" json:"weaknesses"`                             // JSON 数组
	Recommendations           *string               `gorm:"type:longtext" json:"recommendations"`
	ReportContent             *string               `gorm:"type:longtext" json:"report_content"` // HTML/Markdown
	GeneratedBy               string                `gorm:"type:varchar(50);default:'system';not null" json:"generated_by"`
	CreatedAt                 time.Time             `gorm:"index;autoCreateTime;type:timestamp" json:"created_at"`
	UpdatedAt                 time.Time             `gorm:"autoUpdateTime;type:timestamp" json:"updated_at"`

	// 关联
	User       *User                  `gorm:"foreignKey:UserID;references:ID" json:"user,omitempty"`
	Statistics []*ReportStatistic     `json:"statistics,omitempty"`
}

// TableName 指定表名
func (LearningReport) TableName() string {
	return "learning_reports"
}

// StringArray 用于 JSON 数组的自定义类型
type StringArray []string

// Scan 实现 sql.Scanner 接口
func (sa *StringArray) Scan(value interface{}) error {
	if value == nil {
		return nil
	}
	bytes, ok := value.([]byte)
	if !ok {
		return nil
	}
	return json.Unmarshal(bytes, &sa)
}

// Value 实现 driver.Valuer 接口
func (sa StringArray) Value() (driver.Value, error) {
	return json.Marshal(sa)
}

// ReportStatistic 报告统计明细表对应的结构体
type ReportStatistic struct {
	ID                     string                 `gorm:"primaryKey;type:varchar(36)" json:"id"`
	ReportID               string                 `gorm:"index;type:varchar(36);not null" json:"report_id"`
	StatDate               time.Time              `gorm:"index;type:date;not null" json:"stat_date"`
	DailyConversations     int                    `gorm:"type:int;default:0;not null" json:"daily_conversations"`
	DailyEvaluations       int                    `gorm:"type:int;default:0;not null" json:"daily_evaluations"`
	DailyStudyMinutes      int                    `gorm:"type:int;default:0;not null" json:"daily_study_minutes"`
	DailyAvgEvalScore      float64                `gorm:"type:float;default:0.0;not null" json:"daily_avg_eval_score"`
	DailySLevelCount       int                    `gorm:"type:int;default:0;not null" json:"daily_s_level_count"`
	DailyALevelCount       int                    `gorm:"type:int;default:0;not null" json:"daily_a_level_count"`
	DailyBLevelCount       int                    `gorm:"type:int;default:0;not null" json:"daily_b_level_count"`
	DailyCLevelCount       int                    `gorm:"type:int;default:0;not null" json:"daily_c_level_count"`
	TopicBreakdown         TopicBreakdownData     `gorm:"type:json" json:"topic_breakdown"`    // {topic: count}
	DifficultyBreakdown    DifficultyBreakdownData `gorm:"type:json" json:"difficulty_breakdown"` // {level: count}
	CreatedAt              time.Time              `gorm:"autoCreateTime;type:timestamp" json:"created_at"`

	// 关联
	Report *LearningReport `gorm:"foreignKey:ReportID;references:ID" json:"report,omitempty"`
}

// TableName 指定表名
func (ReportStatistic) TableName() string {
	return "report_statistics"
}

// TopicBreakdownData 主题分布数据
type TopicBreakdownData map[string]int

// Scan 实现 sql.Scanner 接口
func (tbd *TopicBreakdownData) Scan(value interface{}) error {
	if value == nil {
		return nil
	}
	bytes, ok := value.([]byte)
	if !ok {
		return nil
	}
	return json.Unmarshal(bytes, &tbd)
}

// Value 实现 driver.Valuer 接口
func (tbd TopicBreakdownData) Value() (driver.Value, error) {
	return json.Marshal(tbd)
}

// DifficultyBreakdownData 难度分布数据
type DifficultyBreakdownData map[string]int

// Scan 实现 sql.Scanner 接口
func (dbd *DifficultyBreakdownData) Scan(value interface{}) error {
	if value == nil {
		return nil
	}
	bytes, ok := value.([]byte)
	if !ok {
		return nil
	}
	return json.Unmarshal(bytes, &dbd)
}

// Value 实现 driver.Valuer 接口
func (dbd DifficultyBreakdownData) Value() (driver.Value, error) {
	return json.Marshal(dbd)
}
```

---

### models/system_setting.go

```go
package models

import "time"

// SystemSetting 系统配置表对应的结构体
type SystemSetting struct {
	ID          string    `gorm:"primaryKey;type:varchar(36)" json:"id"`
	ConfigKey   string    `gorm:"uniqueIndex;type:varchar(100);not null" json:"config_key"`
	ConfigValue string    `gorm:"type:longtext;not null" json:"config_value"` // 支持 JSON
	ConfigType  string    `gorm:"type:enum('string','int','float','json','boolean');not null" json:"config_type"`
	Description *string   `gorm:"type:varchar(500)" json:"description"`
	IsEditable  bool      `gorm:"type:boolean;default:true;not null" json:"is_editable"`
	CreatedAt   time.Time `gorm:"autoCreateTime;type:timestamp" json:"created_at"`
	UpdatedAt   time.Time `gorm:"autoUpdateTime;type:timestamp" json:"updated_at"`
}

// TableName 指定表名
func (SystemSetting) TableName() string {
	return "system_settings"
}

// 系统配置键的常量定义
const (
	ConfigFeedbackSLevelMinScore = "feedback_s_level_min_score"
	ConfigFeedbackALevelMinScore = "feedback_a_level_min_score"
	ConfigFeedbackBLevelMinScore = "feedback_b_level_min_score"
	ConfigFeedbackCLevelMinScore = "feedback_c_level_min_score"
	ConfigForbiddenWords         = "forbidden_words"
	ConfigReportGenerationSchedule = "report_generation_schedule"
)
```

---

## 第四部分：SQL 初始化脚本

### database/init.sql

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS oktalk_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE oktalk_db;

-- 1. 用户基础信息表
CREATE TABLE IF NOT EXISTS users (
    id VARCHAR(36) PRIMARY KEY COMMENT '用户ID',
    username VARCHAR(100) NOT NULL UNIQUE COMMENT '用户名',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT '邮箱',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
    phone VARCHAR(20) COMMENT '手机号',
    avatar_url VARCHAR(500) COMMENT '头像URL',
    grade INT COMMENT '年级(1-6)',
    status ENUM('active','suspended','deleted') NOT NULL DEFAULT 'active' COMMENT '账户状态',
    language VARCHAR(10) NOT NULL DEFAULT 'en' COMMENT '语言偏好',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at TIMESTAMP NULL COMMENT '软删除时间',
    INDEX idx_created_at (created_at),
    INDEX idx_deleted_at (deleted_at),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户基础信息表';

-- 2. 用户扩展信息表
CREATE TABLE IF NOT EXISTS user_profiles (
    id VARCHAR(36) PRIMARY KEY COMMENT '主键ID',
    user_id VARCHAR(36) NOT NULL UNIQUE COMMENT '用户ID',
    full_name VARCHAR(100) COMMENT '真实姓名',
    age INT COMMENT '年龄',
    gender ENUM('male','female','other') COMMENT '性别',
    bio TEXT COMMENT '个人简介',
    total_conversations INT NOT NULL DEFAULT 0 COMMENT '总对话数',
    total_evaluations INT NOT NULL DEFAULT 0 COMMENT '总评测数',
    total_reports INT NOT NULL DEFAULT 0 COMMENT '总报告数',
    average_evaluation_score FLOAT NOT NULL DEFAULT 0.0 COMMENT '平均评测分数',
    last_conversation_at TIMESTAMP NULL COMMENT '上次对话时间',
    last_evaluation_at TIMESTAMP NULL COMMENT '上次评测时间',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_last_conversation_at (last_conversation_at),
    INDEX idx_last_evaluation_at (last_evaluation_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户扩展信息表';

-- 3. 语音对话记录表
CREATE TABLE IF NOT EXISTS voice_conversations (
    id VARCHAR(36) PRIMARY KEY COMMENT '对话ID',
    user_id VARCHAR(36) NOT NULL COMMENT '用户ID',
    topic VARCHAR(200) NOT NULL COMMENT '对话主题',
    difficulty_level ENUM('beginner','intermediate','advanced') NOT NULL DEFAULT 'beginner' COMMENT '难度级别',
    conversation_type ENUM('free_talk','scenario','question_answer') NOT NULL DEFAULT 'free_talk' COMMENT '对话类型',
    message_count INT NOT NULL DEFAULT 0 COMMENT '消息总数',
    duration_seconds INT NOT NULL DEFAULT 0 COMMENT '对话时长',
    status ENUM('active','completed','paused') NOT NULL DEFAULT 'active' COMMENT '状态',
    language_pair VARCHAR(20) NOT NULL DEFAULT 'en-zh' COMMENT '语言对',
    summary TEXT COMMENT '对话摘要',
    ai_model VARCHAR(100) NOT NULL DEFAULT 'gpt-4' COMMENT 'AI模型名',
    score INT COMMENT '对话评分',
    feedback TEXT COMMENT 'AI反馈',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at TIMESTAMP NULL COMMENT '软删除时间',
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_status (status),
    INDEX idx_difficulty_level (difficulty_level),
    INDEX idx_conversation_type (conversation_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='语音对话记录表';

-- 4. 对话消息明细表
CREATE TABLE IF NOT EXISTS conversation_messages (
    id VARCHAR(36) PRIMARY KEY COMMENT '消息ID',
    conversation_id VARCHAR(36) NOT NULL COMMENT '对话ID',
    sender_type ENUM('user','ai') NOT NULL COMMENT '发送者类型',
    sender_id VARCHAR(36) COMMENT '发送者ID',
    message_text LONGTEXT NOT NULL COMMENT '消息文本',
    message_audio_url VARCHAR(500) COMMENT '消息音频URL',
    message_audio_duration INT COMMENT '音频时长',
    ai_response_text LONGTEXT COMMENT 'AI回复文本',
    ai_response_audio_url VARCHAR(500) COMMENT 'AI回复音频URL',
    pronunciation_score INT COMMENT '发音评分',
    pronunciation_feedback TEXT COMMENT '发音反馈',
    sequence_number INT NOT NULL COMMENT '消息序号',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (conversation_id) REFERENCES voice_conversations(id),
    INDEX idx_conversation_id (conversation_id),
    INDEX idx_sequence_number (sequence_number),
    INDEX idx_sender_type (sender_type),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='对话消息明细表';

-- 5. 发音评测记录表
CREATE TABLE IF NOT EXISTS pronunciation_evaluations (
    id VARCHAR(36) PRIMARY KEY COMMENT '评测ID',
    user_id VARCHAR(36) NOT NULL COMMENT '用户ID',
    target_text VARCHAR(500) NOT NULL COMMENT '目标文本',
    recognized_text VARCHAR(500) COMMENT '识别文本',
    audio_url VARCHAR(500) COMMENT '原始录音URL',
    audio_duration INT COMMENT '录音时长',
    overall_score INT NOT NULL DEFAULT 0 COMMENT '综合评分',
    accuracy_score INT NOT NULL DEFAULT 0 COMMENT '准确度评分',
    fluency_score INT NOT NULL DEFAULT 0 COMMENT '流利度评分',
    integrity_score INT NOT NULL DEFAULT 0 COMMENT '完整度评分',
    feedback_level ENUM('S','A','B','C') NOT NULL DEFAULT 'C' COMMENT '反馈级别',
    feedback_text TEXT COMMENT '反馈文本',
    feedback_audio_url VARCHAR(500) COMMENT '反馈音频URL',
    demo_audio_type ENUM('word','sentence') COMMENT '示范音频类型',
    demo_audio_content VARCHAR(500) COMMENT '示范内容',
    demo_audio_url VARCHAR(500) COMMENT '示范音频URL',
    difficulty_level ENUM('beginner','intermediate','advanced') NOT NULL DEFAULT 'beginner' COMMENT '难度级别',
    speech_assessment_json LONGTEXT COMMENT '讯飞原始数据',
    status ENUM('pending','processing','completed','failed') NOT NULL DEFAULT 'completed' COMMENT '状态',
    error_message VARCHAR(500) COMMENT '错误信息',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_feedback_level (feedback_level),
    INDEX idx_overall_score (overall_score),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='发音评测记录表';

-- 6. 评测详细数据表
CREATE TABLE IF NOT EXISTS evaluation_details (
    id VARCHAR(36) PRIMARY KEY COMMENT '主键ID',
    evaluation_id VARCHAR(36) NOT NULL COMMENT '评测ID',
    word_index INT NOT NULL COMMENT '单词序号',
    word_text VARCHAR(100) NOT NULL COMMENT '单词文本',
    word_score INT NOT NULL DEFAULT 0 COMMENT '单词评分',
    is_problem_word BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否问题单词',
    phoneme_details JSON COMMENT '音素详情',
    begin_time_ms INT COMMENT '开始时间',
    end_time_ms INT COMMENT '结束时间',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (evaluation_id) REFERENCES pronunciation_evaluations(id),
    INDEX idx_evaluation_id (evaluation_id),
    INDEX idx_word_index (word_index),
    INDEX idx_is_problem_word (is_problem_word)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评测详细数据表';

-- 7. 反馈记录表
CREATE TABLE IF NOT EXISTS feedback_records (
    id VARCHAR(36) PRIMARY KEY COMMENT '反馈ID',
    evaluation_id VARCHAR(36) NOT NULL UNIQUE COMMENT '评测ID',
    feedback_level ENUM('S','A','B','C') NOT NULL COMMENT '反馈级别',
    feedback_text TEXT NOT NULL COMMENT '反馈文本',
    feedback_audio_url VARCHAR(500) COMMENT '反馈音频URL',
    demo_type ENUM('word','sentence') COMMENT '示范类型',
    demo_content VARCHAR(500) COMMENT '示范内容',
    demo_audio_url VARCHAR(500) COMMENT '示范音频URL',
    generation_method VARCHAR(50) NOT NULL DEFAULT 'llm' COMMENT '生成方法',
    ai_model VARCHAR(100) COMMENT 'AI模型',
    generation_duration_ms INT COMMENT '生成耗时',
    status ENUM('generating','completed','failed') NOT NULL DEFAULT 'completed' COMMENT '状态',
    quality_score INT COMMENT '质量评分',
    user_feedback VARCHAR(500) COMMENT '用户评价',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (evaluation_id) REFERENCES pronunciation_evaluations(id),
    INDEX idx_evaluation_id (evaluation_id),
    INDEX idx_feedback_level (feedback_level),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='反馈记录表';

-- 8. 学习报告表
CREATE TABLE IF NOT EXISTS learning_reports (
    id VARCHAR(36) PRIMARY KEY COMMENT '报告ID',
    user_id VARCHAR(36) NOT NULL COMMENT '用户ID',
    report_type ENUM('weekly','monthly','custom') NOT NULL DEFAULT 'weekly' COMMENT '报告类型',
    period_start_date DATE NOT NULL COMMENT '周期起始日期',
    period_end_date DATE NOT NULL COMMENT '周期结束日期',
    total_conversations INT NOT NULL DEFAULT 0 COMMENT '总对话数',
    total_evaluations INT NOT NULL DEFAULT 0 COMMENT '总评测数',
    total_study_minutes INT NOT NULL DEFAULT 0 COMMENT '总学习时长',
    average_conversation_score FLOAT NOT NULL DEFAULT 0.0 COMMENT '平均对话评分',
    average_evaluation_score FLOAT NOT NULL DEFAULT 0.0 COMMENT '平均评测分数',
    s_level_count INT NOT NULL DEFAULT 0 COMMENT 'S级数',
    a_level_count INT NOT NULL DEFAULT 0 COMMENT 'A级数',
    b_level_count INT NOT NULL DEFAULT 0 COMMENT 'B级数',
    c_level_count INT NOT NULL DEFAULT 0 COMMENT 'C级数',
    improvement_rate FLOAT NOT NULL DEFAULT 0.0 COMMENT '进步率',
    strengths JSON COMMENT '优势',
    weaknesses JSON COMMENT '不足',
    recommendations LONGTEXT COMMENT '建议',
    report_content LONGTEXT COMMENT '报告内容',
    generated_by VARCHAR(50) NOT NULL DEFAULT 'system' COMMENT '生成者',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_report_type (report_type),
    INDEX idx_period_start_date (period_start_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='学习报告表';

-- 9. 报告统计明细表
CREATE TABLE IF NOT EXISTS report_statistics (
    id VARCHAR(36) PRIMARY KEY COMMENT '主键ID',
    report_id VARCHAR(36) NOT NULL COMMENT '报告ID',
    stat_date DATE NOT NULL COMMENT '统计日期',
    daily_conversations INT NOT NULL DEFAULT 0 COMMENT '当日对话数',
    daily_evaluations INT NOT NULL DEFAULT 0 COMMENT '当日评测数',
    daily_study_minutes INT NOT NULL DEFAULT 0 COMMENT '当日学习时长',
    daily_avg_eval_score FLOAT NOT NULL DEFAULT 0.0 COMMENT '当日平均评测分',
    daily_s_level_count INT NOT NULL DEFAULT 0 COMMENT '当日S级数',
    daily_a_level_count INT NOT NULL DEFAULT 0 COMMENT '当日A级数',
    daily_b_level_count INT NOT NULL DEFAULT 0 COMMENT '当日B级数',
    daily_c_level_count INT NOT NULL DEFAULT 0 COMMENT '当日C级数',
    topic_breakdown JSON COMMENT '主题分布',
    difficulty_breakdown JSON COMMENT '难度分布',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (report_id) REFERENCES learning_reports(id),
    INDEX idx_report_id (report_id),
    INDEX idx_stat_date (stat_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='报告统计明细表';

-- 10. 系统配置表
CREATE TABLE IF NOT EXISTS system_settings (
    id VARCHAR(36) PRIMARY KEY COMMENT '主键ID',
    config_key VARCHAR(100) NOT NULL UNIQUE COMMENT '配置键',
    config_value LONGTEXT NOT NULL COMMENT '配置值',
    config_type ENUM('string','int','float','json','boolean') NOT NULL COMMENT '配置类型',
    description VARCHAR(500) COMMENT '配置描述',
    is_editable BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否可编辑',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统配置表';

-- 插入初始系统配置
INSERT INTO system_settings (id, config_key, config_value, config_type, description) VALUES
('set_001', 'feedback_s_level_min_score', '90', 'int', 'S级反馈最低分数'),
('set_002', 'feedback_a_level_min_score', '70', 'int', 'A级反馈最低分数'),
('set_003', 'feedback_b_level_min_score', '50', 'int', 'B级反馈最低分数'),
('set_004', 'feedback_c_level_min_score', '0', 'int', 'C级反馈最低分数'),
('set_005', 'forbidden_words', '["bad","wrong","terrible","fail","mistake","error","poor","awful"]', 'json', '禁用词列表'),
('set_006', 'report_generation_schedule', '0 0 * * 1', 'string', '报告生成时间表(cron)');
```

---

## 第五部分：总结与说明

### 数据库设计要点

1. **表结构简洁**：10 张表，直观对应业务实体
2. **标准化设计**：避免冗余，但保留必要的冗余统计字段（如 user_profiles 中的 total_evaluations）加速查询
3. **JSON 字段使用**：存储复杂嵌套数据（phoneme_details, speech_assessment_json, topic_breakdown）
4. **时间追踪**：所有表均有 created_at/updated_at，支持审计和时序分析
5. **软删除支持**：users 和 voice_conversations 支持软删除（deleted_at）
6. **关联设计**：清晰的外键关系，支持级联查询

### Go Struct 设计要点

1. **GORM Tag 完整**：包含数据库映射、索引、约束等信息
2. **JSON 序列化**：支持 API 响应格式，敏感字段用 json:"-"` 隐藏
3. **关联关系**：Struct 包含指针字段用于 GORM 的关联加载
4. **自定义类型**：PhonemeDetails、StringArray 等实现了 Scanner 和 Valuer 接口，支持 JSON 字段自动转换
5. **无 PO/DTO/VO 分层**：直接使用 Struct 作为单一模型，简化代码

### 性能优化

- **索引策略**：为高频查询字段建立索引（user_id, created_at, feedback_level, status 等）
- **冗余字段**：user_profiles 中维护统计数据，避免每次查询都聚合
- **JSON 字段**：用于存储复杂但不需频繁查询的数据
- **分表设计**：EvaluationDetail 分离出来，支持百万级音素数据存储

这个设计既满足毕业设计的规模需求，也为未来扩展预留了空间！